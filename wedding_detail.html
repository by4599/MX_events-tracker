<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>추가 정보 입력</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;padding:16px;background:#f9f9f9;color:#111}
    .card{max-width:420px;margin:0 auto;background:#fff;padding:16px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    h1{margin:0 0 6px 0;font-size:18px}
    h3{margin:12px 0 8px 0;font-size:16px;font-weight:800}
    label{display:block;margin:8px 0 4px;font-weight:600;font-size:14px}
    .help{font-size:12px;color:#8a8a8a;margin-top:6px}
    .section{margin-top:16px;padding-top:0}
    .hidden{display:none !important}
    .error{color:#b91c1c;font-size:12px;margin-top:6px}
    .muted{color:#8a8a8a}

    input[type="text"],input[type="tel"],select{
      width:100%;padding:10px 12px;font-size:14px;border:1.5px solid #ddd;border-radius:8px;background:#fff;
      transition:.2s;outline:none;box-sizing:border-box
    }
    input::placeholder{color:#aaa;font-size:13px}
    input:focus,select:focus{border-color:#111;box-shadow:0 0 0 3px rgba(17,17,17,.08)}
    .row{display:flex;gap:6px;flex-wrap:wrap}
    .col{flex:1 1 180px}

    .btn{padding:10px 12px;border:0;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px}
    .btn.primary{background:#111;color:#fff}
    .btn.ghost{background:transparent;border:1.5px solid #ddd}
    .btn.full{width:100%}
    .btn.disabled{opacity:.5;cursor:not-allowed}

    .seg{display:flex;gap:6px;flex-wrap:wrap}
    .seg__btn{flex:1;padding:10px 12px;border:1.5px solid #ddd;border-radius:6px;background:#fff;font-weight:600;font-size:14px;cursor:pointer}
    .seg__btn[aria-pressed="true"],.seg__btn.is-selected{background:#111;color:#fff;border-color:#111}

    dialog{border:none;border-radius:12px;max-width:420px;width:calc(100% - 24px);padding:0}
    dialog .dlg-body{padding:16px}
    dialog .dlg-head{padding:12px 16px;font-weight:700}
    dialog .dlg-foot{padding:12px 16px;display:flex;gap:8px;justify-content:flex-end}

    .footer{display:flex;justify-content:center;gap:8px;margin-top:12px}
    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:8px;display:none}
  </style>
</head>
<body>
  <div class="card" role="region" aria-label="추가 정보 입력">
    <h1>추가 정보 입력</h1>
    <p class="help">아래 단계가 순차적으로 열립니다</p>

    <!-- 측 선택 -->
    <section class="section" id="sec-side">
      <div class="seg" role="group" aria-label="신랑측/신부측 선택">
        <button type="button" class="seg__btn" id="btn-groom-side" data-side="groom" aria-pressed="false">신랑측</button>
        <button type="button" class="seg__btn" id="btn-bride-side" data-side="bride" aria-pressed="false">신부측</button>
      </div>
    </section>

    <!-- 성함 선택 -->
    <section class="section hidden" id="sec-person">
      <h3>성함 선택</h3>
      <div class="seg" role="group" aria-label="아버지/어머니/본인 선택">
        <button type="button" class="seg__btn" id="btn-father" data-person="father" aria-pressed="false">아버지</button>
        <button type="button" class="seg__btn" id="btn-mother" data-person="mother" aria-pressed="false">어머니</button>
        <button type="button" class="seg__btn" id="btn-self" data-person="self" aria-pressed="false">본인</button>
      </div>
    </section>

    <!-- 삼성전자 재직여부 -->
    <section class="section hidden" id="sec-status">
      <h3>삼성전자 재직여부</h3>
      <div class="seg" role="group" aria-label="재직/퇴임 선택">
        <button type="button" class="seg__btn" data-status="재직" id="btn-onjob" aria-pressed="false">재직</button>
        <button type="button" class="seg__btn" data-status="퇴임" id="btn-retire" aria-pressed="false">퇴임</button>
      </div>
    </section>

    <!-- (재직시) 근무 부서/직책  -->
    <section class="section hidden" id="sec-onjob">
      <div class="row">
        <div class="col">
          <label id="lbl-dept">근무 부서<span class="req">*</span></label>
          <input type="text" id="dept" placeholder="예) 스마트폰개발1그룹(MX)" autocomplete="organization" />
        </div>
        <div class="col">
          <label id="lbl-title">직책<span class="req">*</span></label>
          <input type="text" id="title" placeholder="예) 상무" autocomplete="organization-title" />
        </div>
      </div>
    </section>

    <!-- (퇴임시) 현직장 및 직책 -->
    <section class="section hidden" id="sec-retire">
      <h3>현직장 및 직책</h3>
      <input type="text" id="curCombined" placeholder="예) OO재단 고문" />
    </section>

    <!-- 청탁금지법 -->
    <section class="section hidden" id="sec-act">
      <h3>청탁금지법(배우자 포함)</h3>
      <div class="seg" role="group" aria-label="청탁금지법 대상 여부">
        <button type="button" class="seg__btn" data-act="비대상" id="btn-act-no" aria-pressed="false">비대상</button>
        <button type="button" class="seg__btn" data-act="대상" id="btn-act-yes" aria-pressed="false">대상</button>
      </div>
      <div id="act-extra" class="hidden" style="margin-top:8px">
        <div class="seg" role="group" aria-label="본인/배우자 선택" style="margin-bottom:8px">
          <button type="button" class="seg__btn" data-who="본인" id="btn-who-self" aria-pressed="false">본인</button>
          <button type="button" class="seg__btn" data-who="배우자" id="btn-who-spouse" aria-pressed="false">배우자</button>
        </div>
        <div id="spouse-wrap" class="hidden">
          <label>배우자 직장 및 직책</label>
          <input type="text" id="spouseCombined" placeholder="예) OO회사 과장" />
        </div>
      </div>
    </section>

    <!-- 축의계좌 -->
    <section class="section hidden" id="sec-account">
      <h3>축의계좌</h3>
      <div class="row">
        <div class="col" id="bankCol">
          <select id="bankSelect">
            <option value="">은행 선택</option>
            <option>국민</option><option>신한</option><option>우리</option>
            <option>하나</option><option>농협</option><option>기업</option>
            <option>새마을금고</option><option>대구</option><option>부산</option>
            <option value="__custom__">직접입력</option>
          </select>
          <input class="hidden" id="bankInput" type="text" placeholder="은행명 입력" />
        </div>
        <div class="col">
          <input type="text" id="account" placeholder="계좌번호(하이픈 포함)" />
        </div>
      </div>
    </section>

    <!-- 연락처 -->
    <section class="section hidden" id="sec-phone">
      <h3>연락처</h3>
      <input type="tel" id="phone" placeholder="010-1234-5678 (하이픈 포함)" />
    </section>

    <!-- 계좌공개 -->
    <section class="section hidden" id="sec-open">
      <h3>계좌공개</h3>
      <div class="seg" role="group" aria-label="계좌공개 선택">
        <button type="button" class="seg__btn" id="btn-open-yes" data-open="희망" aria-pressed="false">희망</button>
        <button type="button" class="seg__btn" id="btn-open-no" data-open="비희망" aria-pressed="false">비희망</button>
      </div>
      <div class="help">* 퇴임임원 안내 문자 내 계좌번호 공개</div>
    </section>

    <!-- 미리보기 -->
    <section class="section hidden" id="sec-preview">
      <button class="btn primary full disabled" id="btn-preview" aria-disabled="true">게시글 미리보기</button>
      <div id="err" class="error hidden"></div>
    </section>

    <!-- Footer -->
    <div class="footer">
      <button class="btn primary" id="btn-submit" disabled>제출</button>
      <a class="btn ghost" href="./wedding.html" id="btn-back">이전</a>
    </div>
  </div>

  <!-- 미리보기 모달 -->
  <dialog id="dlg">
    <div class="dlg-head">게시글 미리보기</div>
    <div class="dlg-body">
      <div style="font-size:14px;line-height:1.4;margin-bottom:8px"><b>제목</b></div>
      <pre id="previewSubject" style="white-space:pre-wrap;font-size:14px;line-height:1.4;margin:0 0 12px 0;background:#f7f7f7;padding:8px;border-radius:8px"></pre>
      <div style="font-size:14px;line-height:1.4;margin-bottom:8px"><b>본문</b></div>
      <pre id="previewBody" style="white-space:pre-wrap;font-size:14px;line-height:1.5;margin:0;background:#f7f7f7;padding:8px;border-radius:8px"></pre>
    </div>
    <div class="dlg-foot">
      <button class="btn ghost" id="dlg-cancel">닫기</button>
      <button class="btn primary" id="dlg-ok">확인하고 제출</button>
    </div>
  </dialog>

  <div class="toast" id="toast"></div>

  <script>
    /* ===== 환경설정 ===== */
    // ✅ GAS 웹앱 엔드포인트 (CORS 허용, Code.gs의 doPost/doGet와 연계)
    const ENDPOINT = "https://script.google.com/macros/s/AKfycb_YOUR_SCRIPT_ID/exec";

    /* ===== 이전 페이지 저장값 로드 (inviteInfo) ===== */
    const KEYMAP = {
      groom: ['groomName','groom','groom_name'],
      bride: ['brideName','bride','bride_name'],
      groomFather: ['groomFather','groom_father','groomFatherName'],
      groomMother: ['groomMother','groom_mother','groomMotherName'],
      brideFather: ['brideFather','bride_father','brideFatherName'],
      brideMother: ['brideMother','bride_mother','brideMotherName']
    };
    const pick = (obj, keys) => { for (const k of keys) if (obj && obj[k]) return String(obj[k]); return ''; };

    function readPrev() {
      let base = {};
      try {
        const s = localStorage.getItem('inviteInfo') || localStorage.getItem('weddingForm');
        if (s) base = JSON.parse(s);
      } catch {}
      const flat = {};
      Object.values(KEYMAP).flat().forEach(k=>{
        const v = localStorage.getItem(k);
        if (v) flat[k] = v;
      });
      const src = { ...base, ...flat };

      // __extract 및 ai_suggestions
      let extract = {};
      try { extract = JSON.parse(localStorage.getItem('inviteExtractRaw') || '{}'); } catch {}
      let ai = {};
      try { ai = JSON.parse(localStorage.getItem('ai_suggestions') || '{}'); } catch {}

      return {
        src,
        extract,
        ai,
        groom:       pick(src, KEYMAP.groom),
        bride:       pick(src, KEYMAP.bride),
        groomFather: pick(src, KEYMAP.groomFather),
        groomMother: pick(src, KEYMAP.groomMother),
        brideFather: pick(src, KEYMAP.brideFather),
        brideMother: pick(src, KEYMAP.brideMother),
        eventDate:   src.eventDate || '', // YYYY-MM-DD
        eventTime:   src.eventTime || '', // HH:MM(24h)
        venueAddr:   src.venueAddr || '',
        venueDetail: src.venueDetail || '',
        venueTel:    (extract.venueTel || '')
      };
    }
    const WF = readPrev();

    /* ===== 상태/유틸 ===== */
    const state = {
      side:'', person:'', status:'',
      dept:'', title:'', curCombined:'',
      act:'', who:'', spouseCombined:'',
      bank:'', account:'', phone:'', open:''
    };
    const el=(id)=>document.getElementById(id);
    const show=(x)=>x.classList.remove('hidden');
    const hide=(x)=>x.classList.add('hidden');
    const enable=(b)=>{b.classList.remove('disabled');b.removeAttribute('aria-disabled');};
    const disable=(b)=>{b.classList.add('disabled');b.setAttribute('aria-disabled','true');};
    const enableSubmit=()=>el('btn-submit').removeAttribute('disabled');
    const disableSubmit=()=>el('btn-submit').setAttribute('disabled','');
    const press=(btn,on)=>{btn.setAttribute('aria-pressed',String(!!on)); if(on){btn.classList.add('is-selected');}else{btn.classList.remove('is-selected');}};
    const toast=(msg)=>{const t=el('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2000);}

    const secPerson=el('sec-person'),secStatus=el('sec-status'),secOnjob=el('sec-onjob'),
          secRetire=el('sec-retire'),secAct=el('sec-act'),secAccount=el('sec-account'),
          secPhone=el('sec-phone'),secOpen=el('sec-open'),secPreview=el('sec-preview'),err=el('err');

    function roleLabel(role, name) { return name ? `${role} · ${name}` : `${role} · 성함 없음`; }

    /* ===== GAS 전송 ===== */
    async function sendAnnouncement(subject, body) {
      const payload = { action: "sendAnnouncement", subject, body };
      const res = await fetch(ENDPOINT, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(`메일 전송 실패(HTTP ${res.status}) ${txt?'- '+txt.slice(0,200):''}`);
      }
      const j = await res.json().catch(()=> ({}));
      if(!j.ok) throw new Error(j.error || "메일 전송 실패");
      return j;
    }

    /* ====== 🔹 AI 제안 로드 & 자동 프리필 ====== */
    // 측/인물 조합 → (bank, account, phone) 제안값 선택
    function pickSuggestion(side, person) {
      const AI = WF.ai || {};
      const map = {
        groom: {
          father: { bank: AI.groomFatherBank, account: AI.groomFatherAccount, phone: AI.groomFatherPhone },
          mother: { bank: AI.groomMotherBank, account: AI.groomMotherAccount, phone: AI.groomMotherPhone },
          self:   { bank: AI.groomBank,       account: AI.groomAccount,       phone: AI.groomPhone }
        },
        bride: {
          father: { bank: AI.brideFatherBank, account: AI.brideFatherAccount, phone: AI.brideFatherPhone },
          mother: { bank: AI.brideMotherBank, account: AI.brideMotherAccount, phone: AI.brideMotherPhone },
          self:   { bank: AI.brideBank,       account: AI.brideAccount,       phone: AI.bridePhone }
        }
      };
      const o = (map[side] && map[side][person]) || {};
      return { bank:(o.bank||'').trim(), account:(o.account||'').trim(), phone:(o.phone||'').trim() };
    }

    // 입력칸에 제안값 반영 (빈 칸일 때만)
    function applySuggestionToInputs(sug) {
      const bankSelect = el('bankSelect');
      const bankInput  = el('bankInput');
      const accountEl  = el('account');
      const phoneEl    = el('phone');

      // 은행
      if (sug.bank) {
        const hasOpt = [...bankSelect.options].some(o => (o.textContent === sug.bank || o.value === sug.bank));
        if (hasOpt) {
          bankSelect.value = sug.bank;
          bankInput.classList.add('hidden');
          bankSelect.classList.remove('hidden');
          state.bank = bankSelect.value;
        } else {
          bankSelect.value = "__custom__";
          bankSelect.classList.add('hidden');
          bankInput.classList.remove('hidden');
          if (!bankInput.value) bankInput.value = sug.bank;
          state.bank = bankInput.value.trim();
        }
      }

      // 계좌
      if (sug.account && !accountEl.value) {
        accountEl.value = sug.account;
        state.account = sug.account;
      }

      // 전화
      if (sug.phone && !phoneEl.value) {
        phoneEl.value = sug.phone;
        state.phone = sug.phone;
      }

      validate();
    }

    /* ===== 측 선택 ===== */
    function selectSide(side){
      state.side=side;
      press(el('btn-groom-side'), side==='groom');
      press(el('btn-bride-side'), side==='bride');
      if(side==='groom'){
        el('btn-father').textContent=roleLabel('아버지',WF.groomFather);
        el('btn-mother').textContent=roleLabel('어머니',WF.groomMother);
        el('btn-self').textContent=roleLabel('본인',WF.groom);
      }else{
        el('btn-father').textContent=roleLabel('아버지',WF.brideFather);
        el('btn-mother').textContent=roleLabel('어머니',WF.brideMother);
        el('btn-self').textContent=roleLabel('본인',WF.bride);
      }
      show(secPerson);

      // 측만 선택해도 '본인' 기준 우선 프리필
      applySuggestionToInputs(pickSuggestion(state.side, 'self'));
    }
    el('btn-groom-side').addEventListener('click',()=>selectSide('groom'));
    el('btn-bride-side').addEventListener('click',()=>selectSide('bride'));

    /* ===== 성함 선택 ===== */
    function selectPerson(p){
      state.person=p;
      press(el('btn-father'),p==='father');
      press(el('btn-mother'),p==='mother');
      press(el('btn-self'),  p==='self');
      show(secStatus);

      applySuggestionToInputs(pickSuggestion(state.side, state.person));
    }
    el('btn-father').addEventListener('click',()=>selectPerson('father'));
    el('btn-mother').addEventListener('click',()=>selectPerson('mother'));
    el('btn-self').addEventListener('click',()=>selectPerson('self'));

    /* ===== 재직/퇴임 ===== */
    function selectStatus(s){
      state.status=s;
      press(el('btn-onjob'), s==='재직');
      press(el('btn-retire'),s==='퇴임');

      if(s==='퇴임'){
        el('lbl-dept').innerHTML='근무 부서 <span class="muted">(재직시)</span>';
        el('lbl-title').innerHTML='직책 <span class="muted">(재직시)</span>';
        show(secOnjob);
        show(secRetire);
      }else{
        el('lbl-dept').innerHTML='근무 부서<span class="req">*</span>';
        el('lbl-title').innerHTML='직책<span class="req">*</span>';
        show(secOnjob);
        hide(secRetire);
      }

      show(secAct); show(secAccount); show(secPhone); show(secOpen); show(secPreview);
      validate();
    }
    el('btn-onjob').addEventListener('click',()=>selectStatus('재직'));
    el('btn-retire').addEventListener('click',()=>selectStatus('퇴임'));

    /* ===== 은행 선택/직접입력 ===== */
    const bankSelect=el('bankSelect'), bankInput=el('bankInput');
    function syncBankState(){
      if(bankSelect && bankSelect.value==='__custom__'){
        bankSelect.classList.add('hidden');
        bankInput.classList.remove('hidden');
        bankInput.focus();
        state.bank = bankInput.value.trim();
      }else if(bankSelect){
        bankInput.classList.add('hidden');
        bankSelect.classList.remove('hidden');
        state.bank = bankSelect.value.trim();
      }
      validate();
    }
    bankSelect.addEventListener('change', syncBankState);
    bankInput.addEventListener('input', ()=>{ state.bank=bankInput.value.trim(); validate(); });

    /* ===== 입력 바인딩 ===== */
    ['dept','title','curCombined','spouseCombined'].forEach(id=>el(id)?.addEventListener('input',e=>{
      state[id]=e.target.value.trim();
      validate();
    }));
    el('account').addEventListener('input',e=>{ state.account=e.target.value; validate(); });
    el('phone').addEventListener('input',e=>{ state.phone=e.target.value; validate(); });

    /* ===== 청탁금지법 ===== */
    function selectAct(v){
      state.act=v;
      press(el('btn-act-no'), v==='비대상');
      press(el('btn-act-yes'), v==='대상');
      if(v==='대상'){
        show(el('act-extra'));
      } else {
        hide(el('act-extra'));
        state.who='';
        press(el('btn-who-self'), false);
        press(el('btn-who-spouse'), false);
        hide(el('spouse-wrap'));
        state.spouseCombined='';
      }
      validate();
    }
    el('btn-act-no').addEventListener('click',()=>selectAct('비대상'));
    el('btn-act-yes').addEventListener('click',()=>selectAct('대상'));

    function selectWho(v){
      state.who=v;
      press(el('btn-who-self'), v==='본인');
      press(el('btn-who-spouse'), v==='배우자');
      if(v==='배우자'){ show(el('spouse-wrap')); } else { hide(el('spouse-wrap')); state.spouseCombined=''; }
      validate();
    }
    el('btn-who-self').addEventListener('click',()=>selectWho('본인'));
    el('btn-who-spouse').addEventListener('click',()=>selectWho('배우자'));

    /* ===== 계좌공개 ===== */
    function selectOpen(v){ state.open=v; press(el('btn-open-yes'),v==='희망'); press(el('btn-open-no'),v==='비희망'); validate(); }
    el('btn-open-yes').addEventListener('click',()=>selectOpen('희망'));
    el('btn-open-no').addEventListener('click',()=>selectOpen('비희망'));

    /* ===== 검증 ===== */
    function validate(){
      err.classList.add('hidden'); err.textContent='';

      if(!state.side||!state.person||!state.status){ disable(el('btn-preview')); disableSubmit(); return; }

      if(state.status==='재직'){
        if(!state.dept||!state.title){ disable(el('btn-preview')); disableSubmit(); return; }
      }else{ // 퇴임
        if(!state.dept||!state.title||!state.curCombined){ disable(el('btn-preview')); disableSubmit(); return; }
      }

      if(state.act==='대상' && !state.who){ disable(el('btn-preview')); disableSubmit(); return; }
      if(state.who==='배우자' && !state.spouseCombined.trim()){ disable(el('btn-preview')); disableSubmit(); return; }

      if(!state.bank){ disable(el('btn-preview')); disableSubmit(); return; }
      if(!/^[0-9-]{6,}$/.test(state.account)){ disable(el('btn-preview')); disableSubmit(); return; }
      if(!/^[0-9-]{10,13}$/.test(state.phone)){ disable(el('btn-preview')); disableSubmit(); return; }

      if(!state.open){ disable(el('btn-preview')); disableSubmit(); return; }

      enable(el('btn-preview')); enableSubmit();
    }

    /* ===== 날짜/요일/포맷 유틸 ===== */
    function parseISO(d){ if(!d) return null; const [y,m,dd]=d.split('-').map(n=>+n); return new Date(y,(m-1),dd); }
    function weekdayChJp(date){
      const map = ['日','月','火','水','木','金','土']; // 예시 제목처럼 土 사용
      return map[date.getDay()];
    }
    function mdLabel(date){ return `${date.getMonth()+1}.${date.getDate()}`; }

    /* ===== 규칙 기반 문안 생성 ===== */
    function buildTitleAndBody(){
      const d = parseISO(WF.eventDate);
      const w = d ? weekdayChJp(d) : '';
      const md = d ? mdLabel(d) : '';

      // 1) 재직/퇴임 라벨
      const corp = (state.status==='재직') ? '삼성전자' : '전)삼성전자';

      // 선택된 사람(표기 이름)
      const nameSet = (state.side==='groom')
        ? { father:WF.groomFather, mother:WF.groomMother, self:WF.groom }
        : { father:WF.brideFather, mother:WF.brideMother, self:WF.bride };
      const subjectName = nameSet[state.person] || '';

      // 2) 장남/장녀 등 문구(상부 노출)
      //   - 신랑측: "아들" 기준: 장남/차남/…
      //   - 신부측: "딸"  기준: 장녀/차녀/…
      const upperLine = (() => {
        const gLine = `${WF.groomFather || ''} · ${WF.groomMother || ''} 의 ${WF.groomOrder || ''} ${WF.groom || ''}`.trim();
        const bLine = `${WF.brideFather || ''} · ${WF.brideMother || ''} 의 ${WF.brideOrder || ''} ${WF.bride || ''}`.trim();
        if(state.side==='groom'){
          // 임원 가족 정보 상부 노출: 여기서는 선택측을 1행에, 상대측을 2행에
          return `${gLine}\n${bLine}`;
        }else{
          return `${bLine}\n${gLine}`;
        }
      })();

      // 3) 식장 정보: 상부 식장명/홀, 하단 주소/전화
      const venueNameHall = WF.venueDetail || ''; // 호텔명/홀명 등
      const venueLower = `${WF.venueAddr || ''}${WF.venueTel ? `\n                (TEL : ${WF.venueTel})` : ''}`;

      // 연락처 표기: "(이름 직책)" 형태
      const contactTail = state.title ? ` (${subjectName} ${state.title})` : ` (${subjectName})`;

      // 축의계좌 표기: "(예금주 이름)" → 선택자 기준
      const acctTail = ` (${subjectName})`;

      // 4) 청탁금지법 라인
      const actLine = (state.act==='대상') ? '※ 청탁금지법 대상' : '※ 청탁금지법 비대상';

      // ===== 제목 & 본문 조립 =====
      const subject = `＜화혼＞ ${corp} ${state.dept || ''} ${subjectName} ${state.title || ''} ${ (state.side==='groom') ? (WF.groomOrder||'')+'결혼' : (WF.brideOrder||'')+'결혼' }(${md} ${w})`.replace(/\s+/g,' ').trim();

      const bodyLines = [];
      bodyLines.push(`${corp} ${state.dept || ''} ${subjectName} ${state.title || ''} ${(state.side==='groom')?'장남결혼':'장녀결혼'}을 안내하오니 많은 축하 부탁드립니다.`);
      bodyLines.push('');
      bodyLines.push(upperLine);
      bodyLines.push('');
      bodyLines.push(`□ 일   시 : ${WF.eventDate ? WF.eventDate.replace(/-/g,'년 ').replace(/-(\d{2})$/,'월 $1일') : ''} ${WF.eventTime ? formatKoreanTime(WF.eventTime) : ''}`);
      bodyLines.push(`□ 장   소 : ${venueNameHall}`);
      bodyLines.push(`                ${venueLower}`);
      bodyLines.push(`□ 연락처 : ${state.phone}${contactTail}`);
      bodyLines.push(`□ 축의금 전달계좌 : ${state.bank} ${state.account}${acctTail}`);
      bodyLines.push(actLine);

      return { subject, body: bodyLines.join('\n') };
    }

    function formatKoreanTime(hhmm){
      // HH:MM(24h) → "오전/오후 H:MM"
      const [h,m] = hhmm.split(':').map(n=>+n);
      const am = (h<12);
      const h12 = (h%12)||12;
      return `${am?'오전':'오후'} ${String(h12)}:${String(m).padStart(2,'0')}`;
    }

    /* ===== 미리보기/제출 ===== */
    function buildPreview(){
      const {subject, body} = buildTitleAndBody();
      return {subject, body};
    }

    el('btn-preview').addEventListener('click',()=>{
      if(el('btn-preview').hasAttribute('aria-disabled')) return;
      const p = buildPreview();
      el('previewSubject').textContent = p.subject;
      el('previewBody').textContent = p.body;
      el('dlg').showModal();
    });
    el('dlg-cancel').addEventListener('click',()=>el('dlg').close());
    el('dlg-ok').addEventListener('click', async ()=>{
      try{
        const p = buildPreview();
        const r = await sendAnnouncement(p.subject, p.body);
        el('dlg').close();
        toast('메일로 전송되었습니다.');
      }catch(e){
        toast(e.message || '전송 실패');
      }
    });

    function submitLocal(){
      localStorage.setItem('weddingDetail', JSON.stringify(state));
      toast('임시 저장되었습니다.');
    }
    document.getElementById('btn-submit').addEventListener('click',()=>{
      if(!el('btn-submit').hasAttribute('disabled')) submitLocal();
    });

    // 초기 검증
    // 페이지 진입 시, WF 값 일부 힌트
    (function initHints(){
      if(!WF.eventDate || !WF.venueDetail){
        console.warn('inviteInfo 일부 값이 비어있습니다.', WF);
      }
    })();

    validate();
  </script>
</body>
</html>

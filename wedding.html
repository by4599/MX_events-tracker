<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>결혼식 정보 입력</title>
<style>
/* (스타일 부분은 기존 그대로 두었습니다) */
</style>
</head>
<body>
<div class="card">
  <h2>결혼식 기본 정보 입력</h2>

  <!-- 청첩장 URL -->
  <div id="inviteUrlBlock">
    <label for="inviteUrl">모바일 청첩장 URL</label>
    <input id="inviteUrl" type="url" placeholder="https://..." />
  </div>

  <!-- 수기 입력 토글 -->
  <div class="toggle-wrapper">
    <span>모바일 청첩장 없음 (수기 입력)</span>
    <label class="switch">
      <input type="checkbox" id="noInvite" />
      <span class="slider"></span>
    </label>
  </div>

  <button class="btn primary" id="btnCheck">AI로 예식 정보 확인</button>
  <div id="msg" class="msg"></div>

  <!-- 신랑측 -->
  <div class="section">
    <h3>신랑측</h3>
    <label for="groomFather">혼주 아버지 성함 *</label>
    <input id="groomFather" type="text" />
    <label for="groomMother">혼주 어머니 성함 *</label>
    <input id="groomMother" type="text" />
    <label for="groomOrder">신랑 형제관계 *</label>
    <select id="groomOrder">
      <option value="">선택</option>
      <option>장남</option><option>차남</option><option>삼남</option>
      <option>사남</option><option>오남</option>
    </select>
    <label for="groomName">신랑 성명 *</label>
    <input id="groomName" type="text" />
  </div>

  <!-- 신부측 -->
  <div class="section">
    <h3>신부측</h3>
    <label for="brideFather">혼주 아버지 성함 *</label>
    <input id="brideFather" type="text" />
    <label for="brideMother">혼주 어머니 성함 *</label>
    <input id="brideMother" type="text" />
    <label for="brideOrder">신부 형제관계 *</label>
    <select id="brideOrder">
      <option value="">선택</option>
      <option>장녀</option><option>차녀</option><option>삼녀</option>
      <option>사녀</option><option>오녀</option>
    </select>
    <label for="brideName">신부 성명 *</label>
    <input id="brideName" type="text" />
  </div>

  <!-- 예식 정보 -->
  <div class="section">
    <h3>예식 정보</h3>
    <input type="hidden" id="eventDate" />
    <input type="hidden" id="eventTime" />
    <label for="eventDateDisplay">예식일시 *</label>
    <input id="eventDateDisplay" type="text" readonly placeholder="YYYY-MM-DD" />
    <input id="eventTimeDisplay" type="text" readonly placeholder="HH:MM" />
    <label for="venueAddr">예식장 주소 *</label>
    <input id="venueAddr" type="text" placeholder="도로명 주소" />
    <label for="venueDetail">예식장 세부 *</label>
    <input id="venueDetail" type="text" placeholder="예식장 이름/홀명" />
  </div>

  <button class="btn primary" id="btnNext">추가 정보 입력</button>
</div>

<script>
/* ================== 설정 ================== */
const ENDPOINT = "https://wedding-proxy.ini203-kim.workers.dev";

/* ================== AI 분석 버튼 ================== */
document.getElementById('btnCheck').addEventListener('click', async () => {
  const msg = document.getElementById('msg');
  const url = document.getElementById('inviteUrl').value.trim();

  if (!url) {
    msg.textContent = "❌ 청첩장 URL을 입력하세요.";
    msg.style.color = "red";
    return;
  }

  msg.textContent = "⏳ AI로 분석 중입니다...";
  msg.style.color = "#333";

  try {
    // ✅ URL 안전 인코딩
    const res = await fetch(ENDPOINT + "?action=extract&url=" + encodeURIComponent(url));
    if (!res.ok) throw new Error("요청 실패");

    const data = await res.json();
    console.log("✅ Gemini 응답:", data);

    if (data.ok) {
      document.getElementById("groomFather").value = data.groomFather || "";
      document.getElementById("groomMother").value = data.groomMother || "";
      document.getElementById("groomOrder").value = data.groomOrder || "";
      document.getElementById("groomName").value   = data.groomName || "";
      document.getElementById("brideFather").value = data.brideFather || "";
      document.getElementById("brideMother").value = data.brideMother || "";
      document.getElementById("brideOrder").value  = data.brideOrder || "";
      document.getElementById("brideName").value   = data.brideName || "";
      document.getElementById("eventDate").value   = data.eventDate || "";
      document.getElementById("eventDateDisplay").value = data.eventDate || "";
      document.getElementById("eventTime").value   = data.eventTime || "";
      document.getElementById("eventTimeDisplay").value = data.eventTime || "";
      document.getElementById("venueAddr").value   = data.venueAddr || "";
      document.getElementById("venueDetail").value = data.venue || "";

      // 로컬스토리지에도 저장
      localStorage.setItem("inviteInfo", JSON.stringify(data));

      msg.textContent = "✅ AI로 예식 정보가 입력되었습니다.";
      msg.style.color = "green";
    } else {
      msg.textContent = "❌ 분석 실패: " + (data.error || "Unknown");
      msg.style.color = "red";
    }
  } catch (err) {
    msg.textContent = "❌ 분석 실패: " + err.message;
    msg.style.color = "red";
  }
});

/* ================== 수기 입력 모드 전환 ================== */
const noInviteEl = document.getElementById('noInvite');
const inviteUrlBlock = document.getElementById('inviteUrlBlock');
const btnCheck = document.getElementById('btnCheck');
function updateInviteMode(){
  const off = noInviteEl.checked;
  inviteUrlBlock.classList.toggle('hidden', off);
  btnCheck.classList.toggle('hidden', off);
  if(off){ document.getElementById('inviteUrl').value=''; }
}
noInviteEl.addEventListener('change', updateInviteMode);
updateInviteMode();

/* ================== 다음 단계 버튼 ================== */
document.getElementById('btnNext').addEventListener('click', () => {
  const info = {
    inviteUrl: document.getElementById('inviteUrl').value,
    noInvite: document.getElementById('noInvite').checked,
    groomFather: document.getElementById('groomFather').value,
    groomMother: document.getElementById('groomMother').value,
    groomOrder: document.getElementById('groomOrder').value,
    groomName: document.getElementById('groomName').value,
    brideFather: document.getElementById('brideFather').value,
    brideMother: document.getElementById('brideMother').value,
    brideOrder: document.getElementById('brideOrder').value,
    brideName: document.getElementById('brideName').value,
    eventDate: document.getElementById('eventDate').value,
    eventTime: document.getElementById('eventTime').value,
    venueAddr: document.getElementById('venueAddr').value,
    venueDetail: document.getElementById('venueDetail').value
  };
  localStorage.setItem("inviteInfo", JSON.stringify(info));
  location.href = 'wedding_detail.html';
});
</script>
</body>
</html>

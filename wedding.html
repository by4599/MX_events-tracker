<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>결혼식 정보 입력</title>
<style>
/* ================== 기본 레이아웃 ================== */
body{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  margin:0; padding:16px; background:#f9f9f9; color:#111;
}
.card{
  max-width:420px; margin:0 auto; background:#fff; padding:16px;
  border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.1);
}
h2{ margin-top:0; font-size:18px; }
label{ display:block; margin:8px 0 4px; font-weight:600; font-size:14px; }

/* ================== 폼 컨트롤 공통 ================== */
input[type="text"], input[type="url"], select{
  width:100%; padding:10px 12px; font-size:14px;
  border:1.5px solid #ddd; border-radius:8px; background:#fff;
  transition:.2s; outline:none; box-sizing:border-box;
}
input::placeholder{ color:#aaa; font-size:13px; }
input:focus, select:focus{ border-color:#111; box-shadow:0 0 0 3px rgba(17,17,17,.08); }

.row{ display:flex; gap:6px; }
.btn{ padding:10px 12px; border:0; border-radius:6px; cursor:pointer; font-weight:600; font-size:14px; }
.btn.primary{ background:#111; color:#fff; width:100%; margin-top:12px; }
.section{ margin-top:16px; padding-top:12px; border-top:1px solid #eee; }
.msg{ margin-top:8px; font-size:13px; }

/* ================== 토글 스위치 ================== */
.toggle-wrapper{ display:flex; align-items:center; justify-content:space-between; margin:12px 0; font-size:14px; }
.switch{ position:relative; display:inline-block; width:42px; height:24px; }
.switch input{ opacity:0; width:0; height:0; }
.slider{ position:absolute; inset:0; cursor:pointer; background:#ccc; border-radius:24px; transition:.3s; }
.slider:before{ content:""; position:absolute; height:18px; width:18px; left:3px; bottom:3px; background:#fff; border-radius:50%; transition:.3s; }
.switch input:checked + .slider{ background:#111; }
.switch input:checked + .slider:before{ transform:translateX(18px); }

/* ================== 커스텀 셀렉트 ================== */
.native-select--hidden{ position:absolute !important; inset:0; opacity:0; pointer-events:none; height:0; width:0; }
.cselect{ position:relative; }
.cselect__btn{
  width:100%; padding:10px 12px; font-size:14px;
  border:1.5px solid #ddd; border-radius:8px; background:#fff;
  display:flex; align-items:center; justify-content:space-between;
}
.cselect__btn:focus{ border-color:#111; box-shadow:0 0 0 3px rgba(17,17,17,.08); }
.cselect__arrow{
  width:16px; height:16px; flex:0 0 16px;
  mask:url("data:image/svg+xml;utf8,<svg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>") no-repeat center / contain;
  background:#111; opacity:.9;
}
.cselect__list{
  position:absolute; z-index:20; left:0; right:0; top:calc(100% + 6px);
  background:#fff; border:1px solid #e5e5e5; border-radius:10px;
  box-shadow:0 6px 16px rgba(0,0,0,.08); max-height:240px; overflow:auto; padding:6px; display:none;
}
.cselect__list.is-open{ display:block; }
.cselect__option{ padding:10px 10px; border-radius:8px; font-size:14px; cursor:pointer; }
.cselect__option[aria-selected="true"]{ background:#111; color:#fff; }
.cselect__option:hover{ background:#f2f2f2; }

.seg{ display:flex; gap:6px; }
.seg__btn{
  flex:1; padding:10px 12px; border:1.5px solid #ddd; border-radius:6px;
  background:#fff; font-weight:600; font-size:14px; cursor:pointer;
}
.seg__btn[aria-pressed="true"], .seg__btn.is-selected{ background:#111; color:#fff; border-color:#111; }

.hidden{ display:none !important; }

/* ================== 날짜/시간 표시 필드 ================== */
.field{ position:relative; }
.display-input{ padding-right:40px; cursor:pointer; background:#fff; }
.display-input[aria-invalid="true"]{ border-color:#f33; box-shadow:0 0 0 3px rgba(255,51,51,.12); }
.input-icon{
  position:absolute; right:12px; top:50%; transform:translateY(-50%);
  width:18px; height:18px; opacity:.9; pointer-events:none;
  background-size:contain; background-repeat:no-repeat; background-position:center;
}

/* ================== 모달(달력/시간 피커) 공통 ================== */
.picker-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:1000; }
.picker{
  position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
  width:min(420px,92vw); background:#fff; border-radius:12px;
  box-shadow:0 20px 48px rgba(0,0,0,.24); display:none; z-index:1001;
}
.picker__hdr{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #eee; }
.picker__title{ font-weight:700; }
.picker__body{ padding:12px; }
.picker__ftr{ display:flex; gap:8px; padding:12px; border-top:1px solid #eee; }
.picker__btn{ flex:1; padding:10px 12px; border-radius:8px; border:1.5px solid #ddd; background:#fff; font-weight:700; cursor:pointer; }
.picker__btn.primary{ background:#111; color:#fff; border-color:#111; }
.icon-btn{ border:1.5px solid #ddd; background:#fff; border-radius:8px; width:36px; height:32px; cursor:pointer; }

.cal-topline{ display:flex; align-items:center; justify-content:space-between; width:100%; gap:8px; }
.cal-left{ font-weight:800; font-size:14px; color:#111; }
.cal-ym{ font-weight:800; font-size:18px; letter-spacing:.3px; }

.cal-head{
  display:grid; grid-template-columns:repeat(7,1fr); gap:4px;
  margin-bottom:6px; font-size:14px; font-weight:700; text-align:center;
}
.cal-head .sun{ color:#C82D2D; }
.cal-head .sat{ color:#142396; }

.cal-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
.cal-day{
  padding:10px 0; text-align:center; border-radius:8px; border:1px solid transparent;
  cursor:pointer; background:#fff; color:#111; font-weight:600;
}
.cal-day:hover{ background:#f5f5f5; }
.cal-day.out{ color:#bbb; cursor:default; background:transparent; }
.cal-day.today{ border-color:#111; }
.cal-day.sel{ background:#111; color:#fff !important; }
.cal-day.sun{ color:#C82D2D !important; }
.cal-day.sat{ color:#142396 !important; }

.time-wrap{ display:flex; gap:8px; }
.time-col{
  flex:1; max-height:260px; overflow-y:auto; overflow-x:hidden;
  border:1px solid #eee; border-radius:12px; background:#fafafa; padding:8px;
}
.time-col--ampm{ flex:.9; }
.time-col::-webkit-scrollbar{ display:none; }
.time-col{ scrollbar-width:none; -ms-overflow-style:none; }
.time-item{
  width:100%; padding:10px 0; margin:4px 0; border-radius:10px;
  cursor:pointer; text-align:center; border:1.5px solid transparent;
  background:#fff; font-weight:600;
}
.time-item:hover{ background:#f5f5f5; }
.time-item.sel{ background:#111; color:#fff; border-color:#111; }

.hint { color:#8a8a8a; font-size:12px; margin-top:6px; display:block; }
.sr-only{
  position:absolute !important; width:1px; height:1px; padding:0; margin:-1px;
  overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
}
</style>
</head>
<body>
<div class="card">
  <h2>결혼식 기본 정보 입력</h2>

  <!-- 청첩장 URL -->
  <div id="inviteUrlBlock">
    <label for="inviteUrl">모바일 청첩장 URL</label>
    <input id="inviteUrl" type="url" placeholder="https://..." />
  </div>

  <!-- 수기 입력 토글 -->
  <div class="toggle-wrapper">
    <span id="noInviteLabel">모바일 청첩장 없음 (수기 입력)</span>
    <label class="switch">
      <input type="checkbox" id="noInvite" aria-labelledby="noInviteLabel" />
      <span class="slider"></span>
    </label>
  </div>

  <button class="btn primary" id="btnCheck">AI로 예식 정보 확인</button>
  <div id="msg" class="msg"></div>

  <!-- 신랑측 -->
  <div class="section">
    <h3>신랑측</h3>
    <label for="groomFather">혼주 아버지 성함 *</label>
    <input id="groomFather" type="text" />
    <label for="groomMother">혼주 어머니 성함 *</label>
    <input id="groomMother" type="text" />
    <label for="groomOrder" id="groomOrderLabel">신랑 형제관계 *</label>
    <select id="groomOrder" class="native-select--hidden" data-ui="custom-select">
      <option value="">선택</option>
      <option>장남</option><option>차남</option><option>삼남</option>
      <option>사남</option><option>오남</option>
    </select>
    <div class="cselect" data-for="groomOrder" aria-haspopup="listbox">
      <button type="button" class="cselect__btn" id="groomOrderBtn" aria-expanded="false">선택<span class="cselect__arrow"></span></button>
      <div class="cselect__list" role="listbox" aria-labelledby="groomOrderLabel groomOrderBtn"></div>
    </div>
    <label for="groomName">신랑 성명 *</label>
    <input id="groomName" type="text" />
  </div>

  <!-- 신부측 -->
  <div class="section">
    <h3>신부측</h3>
    <label for="brideFather">혼주 아버지 성함 *</label>
    <input id="brideFather" type="text" />
    <label for="brideMother">혼주 어머니 성함 *</label>
    <input id="brideMother" type="text" />
    <label for="brideOrder" id="brideOrderLabel">신부 형제관계 *</label>
    <select id="brideOrder" class="native-select--hidden" data-ui="custom-select">
      <option value="">선택</option>
      <option>장녀</option><option>차녀</option><option>삼녀</option>
      <option>사녀</option><option>오녀</option>
    </select>
    <div class="cselect" data-for="brideOrder" aria-haspopup="listbox">
      <button type="button" class="cselect__btn" id="brideOrderBtn" aria-expanded="false">선택<span class="cselect__arrow"></span></button>
      <div class="cselect__list" role="listbox" aria-labelledby="brideOrderLabel brideOrderBtn"></div>
    </div>
    <label for="brideName">신부 성명 *</label>
    <input id="brideName" type="text" />
  </div>

  <!-- 예식 정보 -->
  <div class="section">
    <h3>예식 정보</h3>

    <!-- 저장용 hidden -->
    <input type="hidden" id="eventDate" />
    <input type="hidden" id="eventTime" />

    <label>예식일시 *</label>
    <div class="row">
      <div class="field" style="flex:1;">
        <input id="eventDateDisplay" class="display-input" type="text" placeholder="YYYY.MM.DD" readonly />
        <span class="input-icon" aria-hidden="true"
          style="background-image:url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23111%22 stroke-width=%221.6%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><rect x=%223%22 y=%224%22 width=%2218%22 height=%2217%22 rx=%222%22/><path d=%22M8 2v4M16 2v4M3 9h18%22/></svg>');"></span>
      </div>

      <div class="field" style="flex:1;">
        <input id="eventTimeDisplay" class="display-input" type="text" placeholder="오전 12:30" readonly />
        <span class="input-icon" aria-hidden="true"
          style="background-image:url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23111%22 stroke-width=%221.6%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><circle cx=%2212%22 cy=%2212%22 r=%229%22/><path d=%22M12 7v6l4 2%22/></svg>');"></span>
      </div>
    </div>
    <small class="hint">※ 해외의 경우 현지시간으로 입력 바랍니다.</small>

    <label for="venueAddr">예식장 주소 *</label>
    <input id="venueAddr" type="text" placeholder="도로명 주소 검색" readonly />

    <label for="venueDetail">예식장 세부 *</label>
    <input id="venueDetail" type="text" placeholder="예식장 이름/홀명" />

    <label for="isSmallWeddingInput">스몰웨딩 여부 *</label>
    <div class="seg" data-for="isSmallWeddingInput">
      <button type="button" class="seg__btn" data-value="예" aria-pressed="false">예</button>
      <button type="button" class="seg__btn" data-value="아니오" aria-pressed="false">아니오</button>
    </div>
    <input type="hidden" id="isSmallWeddingInput" value="" />

    <label for="flowerInput">화환 수령 *</label>
    <div class="seg" data-for="flowerInput">
      <button type="button" class="seg__btn" data-value="희망" aria-pressed="false">희망</button>
      <button type="button" class="seg__btn" data-value="비희망" aria-pressed="false">비희망</button>
    </div>
    <input type="hidden" id="flowerInput" value="" />
  </div>

  <button class="btn primary" id="btnNext">추가 정보 입력</button>
</div>

<!-- ================== 오버레이 및 모달 ================== -->
<div id="pickerBackdrop" class="picker-backdrop"></div>

<!-- 날짜 피커 -->
<div id="datePicker" class="picker" role="dialog" aria-modal="true" aria-label="날짜 선택">
  <div class="picker__hdr">
    <div class="cal-topline">
      <div class="cal-left">예식일</div>
      <div class="cal-ym" id="dateYM">0000.00</div>
      <div>
        <button class="icon-btn" id="prevMonth" aria-label="이전 달">‹</button>
        <button class="icon-btn" id="nextMonth" aria-label="다음 달">›</button>
      </div>
    </div>
  </div>
  <div class="picker__body">
    <div class="cal-head">
      <div class="sun">일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div class="sat">토</div>
    </div>
    <div id="calGrid" class="cal-grid"></div>
  </div>
  <div class="picker__ftr">
    <button class="picker__btn" id="dateCancel">취소</button>
    <button class="picker__btn primary" id="dateConfirm">확인</button>
  </div>
  <input type="hidden" id="tempDate" />
  <input type="hidden" id="calYear" /><input type="hidden" id="calMonth" />
  <div style="position:absolute; left:-9999px;" aria-live="polite" id="dateLive"></div>
  <div style="padding:0 14px 12px; color:#111; font-weight:700;" id="dateSelectedText"></div>
</div>

<!-- 시간 피커 -->
<div id="timePicker" class="picker" role="dialog" aria-modal="true" aria-label="시간 선택">
  <div class="picker__hdr">
    <div class="picker__title">시간 선택</div>
  </div>
  <div class="picker__body">
    <span id="ampmGroupLabel" class="sr-only">오전/오후 선택</span>
    <span id="hourGroupLabel" class="sr-only">시간(시) 선택</span>
    <span id="minGroupLabel" class="sr-only">시간(분) 선택</span>
    <div class="time-wrap">
      <div class="time-col time-col--ampm" id="ampmCol" role="group" aria-labelledby="ampmGroupLabel"></div>
      <div class="time-col" id="hourCol" role="group" aria-labelledby="hourGroupLabel"></div>
      <div class="time-col" id="minCol" role="group" aria-labelledby="minGroupLabel"></div>
    </div>
  </div>
  <div class="picker__ftr">
    <button class="picker__btn" id="timeCancel">취소</button>
    <button class="picker__btn primary" id="timeConfirm">확인</button>
  </div>
  <input type="hidden" id="tempHour" /><input type="hidden" id="tempMin" />
</div>

<script>
(function(){
  "use strict";

  /** 0) 상태 배지(오른쪽 아래) */
  const badge = document.createElement('div');
  Object.assign(badge.style, {
    position:'fixed', right:'10px', bottom:'10px', zIndex:9999,
    font:'12px/1.3 system-ui, -apple-system, Segoe UI, Roboto, sans-serif',
    background:'#111', color:'#fff', padding:'8px 10px', borderRadius:'8px',
    boxShadow:'0 4px 12px rgba(0,0,0,.25)', maxWidth:'66vw', whiteSpace:'pre-wrap'
  });
  badge.textContent = 'Guard: init';
  document.addEventListener('DOMContentLoaded', ()=>document.body.appendChild(badge));
  const say = (m)=>{ badge.textContent = 'Guard: ' + m; };

  /** 1) 전역 오류 모니터링 (어디서 터졌는지 배지로 확인) */
  window.addEventListener('error', (e)=> {
    say('ERR ' + (e.message || 'unknown'));
    console.error('[Guard] window error:', e.message, e.error);
  });
  window.addEventListener('unhandledrejection', (e)=>{
    say('REJ ' + (e.reason && e.reason.message ? e.reason.message : String(e.reason)));
    console.error('[Guard] unhandled rejection:', e.reason);
  });

  /** 2) 안전 셀렉터/헬퍼 */
  const $ = (id)=>document.getElementById(id);
  const safe = (fn)=>{ try { return fn(); } catch(e){ console.error('[Guard]', e); say('ERR ' + e.message); } };

  /** 3) 세그먼트 토글 강제 바인딩 (스몰웨딩/화환 버튼이 최소 동작) */
  document.addEventListener('click', function(e){
    const b = e.target.closest('.seg__btn'); if(!b) return;
    const seg = b.closest('.seg'); const hiddenId = seg && seg.getAttribute('data-for');
    const hidden = hiddenId && $(hiddenId);
    seg.querySelectorAll('.seg__btn').forEach(x=>{ x.setAttribute('aria-pressed','false'); x.classList.remove('is-selected'); });
    b.setAttribute('aria-pressed','true'); b.classList.add('is-selected');
    if(hidden) hidden.value = b.dataset.value || '';
    say('seg ok');
  });

  /** 4) 커스텀 셀렉트 라벨 재동기화(형제관계가 AI 주입 후에도 눌리도록) */
  function syncCustomSelect(selectId){
    const sel = $(selectId);
    const wrap = document.querySelector(`.cselect[data-for="${selectId}"]`);
    if(!sel || !wrap) return;
    const btn  = wrap.querySelector('.cselect__btn');
    const list = wrap.querySelector('.cselect__list');
    const opt  = sel.selectedOptions && sel.selectedOptions[0];
    if(btn && opt){
      if(btn.firstChild) btn.firstChild.nodeValue = opt.textContent || '선택';
      else btn.prepend(document.createTextNode(opt.textContent || '선택'));
    }
    if(list){
      [...list.children].forEach(n=>{
        const v = n.getAttribute('data-value');
        n.setAttribute('aria-selected', String(v === sel.value));
      });
    }
    // 의존 로직 깨우기
    sel.dispatchEvent(new Event('change'));
  }

  /** 5) AI 버튼 훅 감싸기 (기존 핸들러가 죽어도 여기서 복구) */
  document.addEventListener('DOMContentLoaded', function(){
    const aiBtn = $('btnCheck');
    if(!aiBtn){ say('no btnCheck'); return; }

    // 기존 핸들러가 등록돼 있더라도, 아래 보조 핸들러는 함께 동작
    aiBtn.addEventListener('click', function(){
      // 5-1) 형제관계 드롭다운 라벨을 강제로 재동기화 (AI 주입 직후 눌림 복구)
      safe(()=>{ syncCustomSelect('groomOrder'); syncCustomSelect('brideOrder'); });

      // 5-2) JSONP 테스트 결과를 배지에 표시(응답이 오는지부터 확인)
      const ENDPOINT = (window.__ENDPOINT_OVERRIDE__) || 
        "<?= 여기에 본인 GAS exec URL 을 넣고, 기존 스크립트에도 동일하게 설정 ?>";
      const url = ($('inviteUrl')?.value || '').trim();
      if(!url){ say('input url?'); return; }

      // JSONP 간이 테스트(서버/콜백이 정상인지)
      const cb = "__ping__" + Math.random().toString(36).slice(2);
      window[cb] = function(data){ 
        say('jsonp ok ' + (data && data.ok ? 'ok' : 'raw'));
        console.log('[Guard] JSONP response', data);
        try{ delete window[cb]; }catch{}
      };
      const s = document.createElement('script');
      s.onerror = ()=>{ say('jsonp net err'); };
      s.src = ENDPOINT + "?action=ping&callback=" + cb;
      document.head.appendChild(s);

      // 5-3) 마지막으로, 필수 필드가 비어 있더라도 버튼/토글은 항상 동작해야 한다는 신호
      say('btn wired');
    }, { capture:true }); // capture로 보장
  });

  /** 6) 다음 단계 버튼이 전혀 안먹는 상황 대비: 최소 동작 보장 */
  document.addEventListener('DOMContentLoaded', function(){
    const next = $('btnNext');
    if(!next) return;
    next.addEventListener('click', function(){
      // 기존 검사 로직이 죽었어도 최소한 페이지 전환은 하게끔(디버그용)
      try {
        const info = {
          groomFather: $('groomFather')?.value || '',
          groomMother: $('groomMother')?.value || '',
          groomOrder:  $('groomOrder')?.value  || '',
          groomName:   $('groomName')?.value   || '',
          brideFather: $('brideFather')?.value || '',
          brideMother: $('brideMother')?.value || '',
          brideOrder:  $('brideOrder')?.value  || '',
          brideName:   $('brideName')?.value   || '',
          eventDate:   $('eventDate')?.value   || '',
          eventTime:   $('eventTime')?.value   || '',
          venueAddr:   $('venueAddr')?.value   || '',
          venueDetail: $('venueDetail')?.value || ''
        };
        localStorage.setItem('inviteInfo', JSON.stringify(info));
        say('go detail');
        location.href = 'wedding_detail.html';
      } catch(e){
        say('next ERR ' + e.message);
      }
    }, { capture:true });
  });

})();
</script>
</body>
</html>

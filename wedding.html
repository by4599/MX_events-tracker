<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ê²°í˜¼ì‹ ì •ë³´ ì…ë ¥</title>
<style>
/* ================== ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ================== */
body{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  margin:0; padding:16px; background:#f9f9f9; color:#111;
}
.card{
  max-width:420px; margin:0 auto; background:#fff; padding:16px;
  border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.1);
}
h2{ margin-top:0; font-size:18px; }
label{ display:block; margin:8px 0 4px; font-weight:600; font-size:14px; }

/* ================== í¼ ì»¨íŠ¸ë¡¤ ê³µí†µ ================== */
input[type="text"], input[type="url"], select{
  width:100%; padding:10px 12px; font-size:14px;
  border:1.5px solid #ddd; border-radius:8px; background:#fff;
  transition:.2s; outline:none; box-sizing:border-box;
}
input::placeholder{ color:#aaa; font-size:13px; }
input:focus, select:focus{ border-color:#111; box-shadow:0 0 0 3px rgba(17,17,17,.08); }

.row{ display:flex; gap:6px; }
.btn{ padding:10px 12px; border:0; border-radius:6px; cursor:pointer; font-weight:600; font-size:14px; }
.btn.primary{ background:#111; color:#fff; width:100%; margin-top:12px; }
.section{ margin-top:16px; padding-top:12px; border-top:1px solid #eee; }
.msg{ margin-top:8px; font-size:13px; }

/* ================== í† ê¸€ ìŠ¤ìœ„ì¹˜ ================== */
.toggle-wrapper{ display:flex; align-items:center; justify-content:space-between; margin:12px 0; font-size:14px; }
.switch{ position:relative; display:inline-block; width:42px; height:24px; }
.switch input{ opacity:0; width:0; height:0; }
.slider{ position:absolute; inset:0; cursor:pointer; background:#ccc; border-radius:24px; transition:.3s; }
.slider:before{ content:""; position:absolute; height:18px; width:18px; left:3px; bottom:3px; background:#fff; border-radius:50%; transition:.3s; }
.switch input:checked + .slider{ background:#111; }
.switch input:checked + .slider:before{ transform:translateX(18px); }

/* ================== ì»¤ìŠ¤í…€ ì…€ë ‰íŠ¸ ================== */
.native-select--hidden{ position:absolute !important; inset:0; opacity:0; pointer-events:none; height:0; width:0; }
.cselect{ position:relative; }
.cselect__btn{
  width:100%; padding:10px 12px; font-size:14px;
  border:1.5px solid #ddd; border-radius:8px; background:#fff;
  display:flex; align-items:center; justify-content:space-between;
}
.cselect__btn:focus{ border-color:#111; box-shadow:0 0 0 3px rgba(17,17,17,.08); }
.cselect__arrow{
  width:16px; height:16px; flex:0 0 16px;
  mask:url("data:image/svg+xml;utf8,<svg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>") no-repeat center / contain;
  background:#111; opacity:.9;
}
.cselect__list{
  position:absolute; z-index:20; left:0; right:0; top:calc(100% + 6px);
  background:#fff; border:1px solid #e5e5e5; border-radius:10px;
  box-shadow:0 6px 16px rgba(0,0,0,.08); max-height:240px; overflow:auto; padding:6px; display:none;
}
.cselect__list.is-open{ display:block; }
.cselect__option{ padding:10px 10px; border-radius:8px; font-size:14px; cursor:pointer; }
.cselect__option[aria-selected="true"]{ background:#111; color:#fff; }
.cselect__option:hover{ background:#f2f2f2; }

.seg{ display:flex; gap:6px; }
.seg__btn{
  flex:1; padding:10px 12px; border:1.5px solid #ddd; border-radius:6px;
  background:#fff; font-weight:600; font-size:14px; cursor:pointer;
}
.seg__btn[aria-pressed="true"], .seg__btn.is-selected{ background:#111; color:#fff; border-color:#111; }

.hidden{ display:none !important; }

/* ================== ë‚ ì§œ/ì‹œê°„ í‘œì‹œ í•„ë“œ ================== */
.field{ position:relative; }
.display-input{ padding-right:40px; cursor:pointer; background:#fff; }
.field--flex1{ flex:1; } /* ADDED: flex:1 ëŒ€ì²´ */
.display-input[aria-invalid="true"]{ border-color:#f33; box-shadow:0 0 0 3px rgba(255,51,51,.12); }
.input-icon{
  position:absolute; right:12px; top:50%; transform:translateY(-50%);
  width:18px; height:18px; opacity:.9; pointer-events:none;
  background-size:contain; background-repeat:no-repeat; background-position:center;
}
/* ADDED: ì•„ì´ì½˜ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤í™” */
.input-icon.icon-calendar{
  background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23111" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="17" rx="2"/><path d="M8 2v4M16 2v4M3 9h18"/></svg>');
}
.input-icon.icon-clock{
  background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23111" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"/><path d="M12 7v6l4 2"/></svg>');
}
/* ADDED: Firefox ìŠ¤í¬ë¡¤ ìˆ¨ê¹€ ì¶”ê°€ */
@supports (scrollbar-width: none){ .time-col{ scrollbar-width: none; } }

/* ================== ëª¨ë‹¬(ë‹¬ë ¥/ì‹œê°„ í”¼ì»¤) ê³µí†µ ================== */
.picker-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:1000; }
.picker{
  position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
  width:min(420px,92vw); background:#fff; border-radius:12px;
  box-shadow:0 20px 48px rgba(0,0,0,.24); display:none; z-index:1001;
}
.picker__hdr{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #eee; }
.picker__title{ font-weight:700; }
.picker__body{ padding:12px; }
.picker__ftr{ display:flex; gap:8px; padding:12px; border-top:1px solid #eee; }
.picker__btn{ flex:1; padding:10px 12px; border-radius:8px; border:1.5px solid #ddd; background:#fff; font-weight:700; cursor:pointer; }
.picker__btn.primary{ background:#111; color:#fff; border-color:#111; }
.icon-btn{ border:1.5px solid #ddd; background:#fff; border-radius:8px; width:36px; height:32px; cursor:pointer; }

.cal-topline{ display:flex; align-items:center; justify-content:space-between; width:100%; gap:8px; }
.cal-left{ font-weight:800; font-size:14px; color:#111; }
.cal-ym{ font-weight:800; font-size:18px; letter-spacing:.3px; }

.cal-head{
  display:grid; grid-template-columns:repeat(7,1fr); gap:4px;
  margin-bottom:6px; font-size:14px; font-weight:700; text-align:center;
}
.cal-head .sun{ color:#C82D2D; }
.cal-head .sat{ color:#142396; }

.cal-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
.cal-day{
  padding:10px 0; text-align:center; border-radius:8px; border:1px solid transparent;
  cursor:pointer; background:#fff; color:#111; font-weight:600;
}
.cal-day:hover{ background:#f5f5f5; }
.cal-day.out{ color:#bbb; cursor:default; background:transparent; }
.cal-day.today{ border-color:#111; }
.cal-day.sel{ background:#111; color:#fff !important; }
.cal-day.sun{ color:#C82D2D !important; }
.cal-day.sat{ color:#142396 !important; }

.time-wrap{ display:flex; gap:8px; }
.time-col{
  flex:1; max-height:260px; overflow-y:auto; overflow-x:hidden;
  border:1px solid #eee; border-radius:12px; background:#fafafa; padding:8px;
}
.time-col--ampm{ flex:.9; }
.time-col::-webkit-scrollbar{ display:none; } /* Chrome, Safari, Opera */
.time-col{ -ms-overflow-style:none; } /* IE and Edge */ /* CHANGED: scrollbar-width: none ì œê±° */
.date-picker-text{ padding:0 14px 12px; color:#111; font-weight:700; } /* ADDED: ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ëŒ€ì²´ */
.time-item{
  width:100%; padding:10px 0; margin:4px 0; border-radius:10px;
  cursor:pointer; text-align:center; border:1.5px solid transparent;
  background:#fff; font-weight:600;
}
.time-item:hover{ background:#f5f5f5; }
.time-item.sel{ background:#111; color:#fff; border-color:#111; }

.hint { color:#8a8a8a; font-size:12px; margin-top:6px; display:block; }
.sr-only{
  position:absolute !important; width:1px; height:1px; padding:0; margin:-1px;
  overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
}
.sr-abs-left{ position:absolute !important; left:-9999px; } /* ADDED: ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ëŒ€ì²´ */
</style>
</head>
<body>
<div class="card">
  <h2>ê²°í˜¼ì‹ ê¸°ë³¸ ì •ë³´ ì…ë ¥</h2>

  <div id="inviteUrlBlock">
    <label for="inviteUrl">ëª¨ë°”ì¼ ì²­ì²©ì¥ URL</label>
    <input id="inviteUrl" type="url" placeholder="https://..." />
  </div>

  <div class="toggle-wrapper">
    <span id="noInviteLabel">ëª¨ë°”ì¼ ì²­ì²©ì¥ ì—†ìŒ (ìˆ˜ê¸° ì…ë ¥)</span>
    <label class="switch">
      <input type="checkbox" id="noInvite" aria-labelledby="noInviteLabel" />
      <span class="slider"></span>
    </label>
  </div>

  <button class="btn primary" id="btnCheck">AIë¡œ ì˜ˆì‹ ì •ë³´ í™•ì¸</button>
  <div id="msg" class="msg"></div>

  <div class="section">
    <h3>ì‹ ë‘ì¸¡</h3>
    <label for="groomFather">í˜¼ì£¼ ì•„ë²„ì§€ ì„±í•¨ *</label>
    <input id="groomFather" type="text" />
    <label for="groomMother">í˜¼ì£¼ ì–´ë¨¸ë‹ˆ ì„±í•¨ *</label>
    <input id="groomMother" type="text" />
    <label for="groomOrder" id="groomOrderLabel">ì‹ ë‘ í˜•ì œê´€ê³„ *</label>
    <select id="groomOrder" class="native-select--hidden" data-ui="custom-select">
      <option value="">ì„ íƒ</option>
      <option>ì¥ë‚¨</option><option>ì°¨ë‚¨</option><option>ì‚¼ë‚¨</option>
      <option>ì‚¬ë‚¨</option><option>ì˜¤ë‚¨</option>
    </select>
    <div class="cselect" data-for="groomOrder" aria-haspopup="listbox">
      <button type="button" class="cselect__btn" id="groomOrderBtn" aria-expanded="false">ì„ íƒ<span class="cselect__arrow"></span></button>
      <div class="cselect__list" role="listbox" aria-labelledby="groomOrderLabel groomOrderBtn"></div>
    </div>
    <label for="groomName">ì‹ ë‘ ì„±ëª… *</label>
    <input id="groomName" type="text" />
  </div>

  <div class="section">
    <h3>ì‹ ë¶€ì¸¡</h3>
    <label for="brideFather">í˜¼ì£¼ ì•„ë²„ì§€ ì„±í•¨ *</label>
    <input id="brideFather" type="text" />
    <label for="brideMother">í˜¼ì£¼ ì–´ë¨¸ë‹ˆ ì„±í•¨ *</label>
    <input id="brideMother" type="text" />
    <label for="brideOrder" id="brideOrderLabel">ì‹ ë¶€ í˜•ì œê´€ê³„ *</label>
    <select id="brideOrder" class="native-select--hidden" data-ui="custom-select">
      <option value="">ì„ íƒ</option>
      <option>ì¥ë…€</option><option>ì°¨ë…€</option><option>ì‚¼ë…€</option>
      <option>ì‚¬ë…€</option><option>ì˜¤ë…€</option>
    </select>
    <div class="cselect" data-for="brideOrder" aria-haspopup="listbox">
      <button type="button" class="cselect__btn" id="brideOrderBtn" aria-expanded="false">ì„ íƒ<span class="cselect__arrow"></span></button>
      <div class="cselect__list" role="listbox" aria-labelledby="brideOrderLabel brideOrderBtn"></div>
    </div>
    <label for="brideName">ì‹ ë¶€ ì„±ëª… *</label>
    <input id="brideName" type="text" />
  </div>

  <div class="section">
    <h3>ì˜ˆì‹ ì •ë³´</h3>

    <input type="hidden" id="eventDate" />
    <input type="hidden" id="eventTime" />

    <label id="eventDateLabel">ì˜ˆì‹ì¼ì‹œ *</label> <div class="row">
      <div class="field field--flex1"> <input id="eventDateDisplay" class="display-input" type="text" placeholder="YYYY.MM.DD" readonly aria-labelledby="eventDateLabel" aria-required="true" /> <span class="input-icon icon-calendar" aria-hidden="true"></span>
      </div>

      <div class="field field--flex1"> <input id="eventTimeDisplay" class="display-input" type="text" placeholder="ì˜¤ì „ 12:30" readonly aria-labelledby="eventDateLabel" aria-required="true" /> <span class="input-icon icon-clock" aria-hidden="true"></span>
      </div>
    </div>
    <small class="hint">â€» í•´ì™¸ì˜ ê²½ìš° í˜„ì§€ì‹œê°„ìœ¼ë¡œ ì…ë ¥ ë°”ëë‹ˆë‹¤.</small>

    <label for="venueAddr">ì˜ˆì‹ì¥ ì£¼ì†Œ *</label>
    <input id="venueAddr" type="text" placeholder="ë„ë¡œëª… ì£¼ì†Œ ê²€ìƒ‰" readonly />

    <label for="venueDetail">ì˜ˆì‹ì¥ ì„¸ë¶€ *</label>
    <input id="venueDetail" type="text" placeholder="ì˜ˆì‹ì¥ ì´ë¦„/í™€ëª…" />

    <label for="isSmallWeddingInput">ìŠ¤ëª°ì›¨ë”© ì—¬ë¶€ *</label>
    <div class="seg" data-for="isSmallWeddingInput">
      <button type="button" class="seg__btn" data-value="ì˜ˆ" aria-pressed="false">ì˜ˆ</button>
      <button type="button" class="seg__btn" data-value="ì•„ë‹ˆì˜¤" aria-pressed="false">ì•„ë‹ˆì˜¤</button>
    </div>
    <input type="hidden" id="isSmallWeddingInput" value="" />

    <label for="flowerInput">í™”í™˜ ìˆ˜ë ¹ *</label>
    <div class="seg" data-for="flowerInput">
      <button type="button" class="seg__btn" data-value="í¬ë§" aria-pressed="false">í¬ë§</button>
      <button type="button" class="seg__btn" data-value="ë¹„í¬ë§" aria-pressed="false">ë¹„í¬ë§</button>
    </div>
    <input type="hidden" id="flowerInput" value="" />
  </div>

  <button class="btn primary" id="btnNext">ì¶”ê°€ ì •ë³´ ì…ë ¥</button>
</div>

<div id="pickerBackdrop" class="picker-backdrop"></div>

<div id="datePicker" class="picker" role="dialog" aria-modal="true" aria-label="ë‚ ì§œ ì„ íƒ">
  <div class="picker__hdr">
    <div class="cal-topline">
      <div class="cal-left">ì˜ˆì‹ì¼</div>
      <div class="cal-ym" id="dateYM">0000.00</div>
      <div>
        <button class="icon-btn" id="prevMonth" aria-label="ì´ì „ ë‹¬">â€¹</button>
        <button class="icon-btn" id="nextMonth" aria-label="ë‹¤ìŒ ë‹¬">â€º</button>
      </div>
    </div>
  </div>
  <div class="picker__body">
    <div class="cal-head">
      <div class="sun">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="sat">í† </div>
    </div>
    <div id="calGrid" class="cal-grid"></div>
  </div>
  <div class="picker__ftr">
    <button class="picker__btn" id="dateCancel">ì·¨ì†Œ</button>
    <button class="picker__btn primary" id="dateConfirm">í™•ì¸</button>
  </div>
  <input type="hidden" id="tempDate" />
  <input type="hidden" id="calYear" /><input type="hidden" id="calMonth" />
  <div class="sr-abs-left" aria-live="polite" id="dateLive"></div> <div class="date-picker-text" id="dateSelectedText"></div> </div>

<div id="timePicker" class="picker" role="dialog" aria-modal="true" aria-label="ì‹œê°„ ì„ íƒ">
  <div class="picker__hdr">
    <div class="picker__title">ì‹œê°„ ì„ íƒ</div>
  </div>
  <div class="picker__body">
    <span id="ampmGroupLabel" class="sr-only">ì˜¤ì „/ì˜¤í›„ ì„ íƒ</span>
    <span id="hourGroupLabel" class="sr-only">ì‹œê°„(ì‹œ) ì„ íƒ</span>
    <span id="minGroupLabel" class="sr-only">ì‹œê°„(ë¶„) ì„ íƒ</span>
    <div class="time-wrap">
      <div class="time-col time-col--ampm" id="ampmCol" role="group" aria-labelledby="ampmGroupLabel"></div>
      <div class="time-col" id="hourCol" role="group" aria-labelledby="hourGroupLabel"></div>
      <div class="time-col" id="minCol" role="group" aria-labelledby="minGroupLabel"></div>
    </div>
  </div>
  <div class="picker__ftr">
    <button class="picker__btn" id="timeCancel">ì·¨ì†Œ</button>
    <button class="picker__btn primary" id="timeConfirm">í™•ì¸</button>
  </div>
  <input type="hidden" id="tempHour" /><input type="hidden" id="tempMin" />
</div>

<script>
(function(){
Â  "use strict";

Â  /* === 0) ì„¤ì • === */
Â  const ENDPOINT = "https://script.google.com/macros/s/AKfycbwsBf2tcQ_17Fpu_yDcEcn4uQDnZ0T8bU5L9KJtkgCCvXOsn5IfKEwVTP5_o7-fQmbvww/exec"; // â† ë³¸ì¸ exec URL
Â  const POLLING_INTERVAL = 2000; // ğŸš¨ 2ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸ (ë¹„ë™ê¸°)
Â  let currentPollingInterval = null; // ğŸš¨ í´ë§ íƒ€ì´ë¨¸ ID ì €ì¥ìš©

Â  /* === 1) DOM í—¬í¼ === */
Â  const $ = (id)=>document.getElementById(id);
Â  let guardBadge = null;
Â  const say = (m)=>{ if(guardBadge) guardBadge.textContent = "Guard: " + m; };
  const msgEl = $('msg'); // ë©”ì‹œì§€ ì—˜ë¦¬ë¨¼íŠ¸ ìºì‹±

  function setMsg(text, color="red") {
    msgEl.textContent = text;
    msgEl.style.color = color;
  }

Â  /* === 2) ë‚ ì§œ/ì‹œê°„ ìœ í‹¸ (ê¸°ì¡´ ë¡œì§ ìœ ì§€) === */
Â  const pad = (n)=>String(n).padStart(2,'0');

Â  function normalizeToHHMM(raw){
Â  Â  if(!raw) return '';
Â  Â  let s = String(raw).trim()
Â  Â  Â  .replace(/\s+/g,' ')
Â  Â  Â  .replace(/ì‹œ/g,':')
Â  Â  Â  .replace(/ë¶„/g,'')
Â  Â  Â  .replace(/\.00\b/g,':00');
Â  Â  // 1300 -> 13:00
Â  Â  if(/^\d{3,4}$/.test(s) && !s.includes(':')){
Â  Â  Â  const mm = s.slice(-2), hh = s.slice(0, s.length-2);
Â  Â  Â  s = `${hh}:${mm}`;
Â  Â  }
Â  Â  const hms = s.match(/^(\d{1,2}):(\d{2})(?::\d{2})?$/);
Â  Â  const apÂ  = s.match(/^(ì˜¤ì „|ì˜¤í›„|AM|PM|am|pm)\s*(\d{1,2})(?::|ì‹œ)?\s*(\d{2})?$/);
Â  Â  if(ap){
Â  Â  Â  const ampm = ap[1].toLowerCase();
Â  Â  Â  let h12 = parseInt(ap[2],10);
Â  Â  Â  const mm = ap[3] || '00';
Â  Â  Â  if(ampm==='ì˜¤ì „' || ampm==='am'){ if(h12===12) h12=0; }
Â  Â  Â  else { if(h12<12) h12+=12; }
Â  Â  Â  return `${pad(h12)}:${mm}`;
Â  Â  }
Â  Â  if(hms){
Â  Â  Â  let hh = parseInt(hms[1],10);
Â  Â  Â  const mm = hms[2];
Â  Â  Â  if(hh>24) hh = hh % 24;
Â  Â  Â  return `${pad(hh)}:${mm}`;
Â  Â  }
Â  Â  return '';
Â  }

Â  function extractDateAndTimeKR(raw){
Â  Â  const out = { date:'', time:'' };
Â  Â  if(!raw) return out;
Â  Â  const s = String(raw).trim();
Â  Â  // ì˜ˆ: 2025ë…„ 11ì›” 8ì¼ í† ìš”ì¼ ì˜¤í›„ 3ì‹œ 30ë¶„
Â  Â  const re = /(?:(\d{4})\s*ë…„\s*(\d{1,2})\s*ì›”\s*(\d{1,2})\s*ì¼)?(?:\s*[ì¼ì›”í™”ìˆ˜ëª©ê¸ˆí† ]ìš”ì¼)?(?:\s*(ì˜¤ì „|ì˜¤í›„|AM|PM|am|pm)?\s*(\d{1,2})(?:\s*ì‹œ)?(?:\s*(\d{1,2})\s*ë¶„?)?)?/;
Â  Â  const m = s.match(re);
Â  Â  if(m){
Â  Â  Â  const [, yy, mm, dd, ap, hStr, minStr] = m;
Â  Â  Â  if(yy && mm && dd){ out.date = `${yy}-${pad(mm)}-${pad(dd)}`; }
Â  Â  Â  if(hStr){
Â  Â  Â  Â  const mm2 = minStr?pad(minStr):'00';
Â  Â  Â  Â  if(ap){
Â  Â  Â  Â  Â  let h = parseInt(hStr,10)||0;
Â  Â  Â  Â  Â  const apLow = ap.toLowerCase();
Â  Â  Â  Â  Â  if(apLow==='ì˜¤ì „'||apLow==='am'){ if(h===12) h=0; } else { if(h<12) h+=12; }
Â  Â  Â  Â  Â  out.time = `${pad(h)}:${mm2}`;
Â  Â  Â  Â  }else{
Â  Â  Â  Â  Â  out.time = normalizeToHHMM(`${hStr}:${mm2}`);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  Â  if(!out.time){
Â  Â  Â  const t = normalizeToHHMM(s);
Â  Â  Â  if(t) out.time = t;
Â  Â  }
Â  Â  return out;
Â  }

Â  function to12h(h24){
Â  Â  const n = parseInt(h24,10);
Â  Â  if(isNaN(n)) return {ampm:'ì˜¤ì „', h:'12'};
Â  Â  if(n===0) return {ampm:'ì˜¤ì „', h:'12'};
Â  Â  if(n===12) return {ampm:'ì˜¤í›„', h:'12'};
Â  Â  if(n>12) return {ampm:'ì˜¤í›„', h:String(n-12).padStart(2,'0')};
Â  Â  return {ampm:'ì˜¤ì „', h:String(n).padStart(2,'0')};
Â  }

Â  function setDateDisplay(iso){
Â  Â  const dateHidden = $('eventDate');
Â  Â  const dateDisplay = $('eventDateDisplay');
Â  Â  const pretty = (x)=> x ? x.split('-').join('.') : '';
Â  Â  dateHidden.value = iso || '';
Â  Â  dateDisplay.value = iso ? pretty(iso) : '';
Â  Â  dateDisplay.removeAttribute('aria-invalid');
Â  }

Â  function setTimeDisplay(v){
Â  Â  const timeHidden = $('eventTime');
Â  Â  const timeDisplay = $('eventTimeDisplay');
Â  Â  const norm = normalizeToHHMM(v);
Â  Â  if(norm){
Â  Â  Â  timeHidden.value = norm;
Â  Â  Â  const [hh,mm] = norm.split(':'); const t = to12h(hh);
Â  Â  Â  timeDisplay.value = `${t.ampm} ${t.h}:${mm}`;
Â  Â  Â  timeDisplay.removeAttribute('aria-invalid');
Â  Â  }else{
Â  Â  Â  timeHidden.value = ''; timeDisplay.value = '';
Â  Â  }
Â  }
  
Â  /* === 3) JSONP ìš”ì²­ ìœ í‹¸ë¦¬í‹° (í´ë§ì„ ìœ„í•´ ì¬ì‘ì„±) === */
Â  function loadJsonpScript(url, callbackName){
    const cb = callbackName || "__cb__" + Math.random().toString(36).slice(2);
Â  Â  const s = document.createElement('script');
Â  Â  const full = url + (url.includes('?')?'&':'?') + "callback=" + cb;
Â  Â  window[cb]=function(d){ 
      // ì½œë°± ì‹¤í–‰ í›„ window[cb]ë¥¼ ì‚­ì œ (í´ë§ ì‹œ ì¬í™œìš© ë°©ì§€)
      if(callbackName) window[callbackName](d); else { delete window[cb]; }
    };
Â  Â  s.onerror=function(){
      // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ í´ë§ ì¤‘ì§€
      if (currentPollingInterval) { 
          clearInterval(currentPollingInterval); 
          setMsg("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì¸í•´ ì¶”ì¶œ ì‹¤íŒ¨. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.");
          currentPollingInterval = null;
      }
      if(s.parentNode) s.parentNode.removeChild(s);
    };
    s.onload = function() {
        if(s.parentNode) s.parentNode.removeChild(s);
    };
Â  Â  s.src=full; document.head.appendChild(s);
    return cb;
Â  }
  
  // REMOVED: ê¸°ì¡´ Promise ê¸°ë°˜ jsonp í•¨ìˆ˜ ì œê±°

  /* === 4) ë¹„ë™ê¸° í´ë§ ë¡œì§ (ADDED) === */

  /**
   * 1ë‹¨ê³„: ì¶”ì¶œ ì‘ì—… ì‹œì‘ ìš”ì²­
   */
  function startExtraction(url) {
      // ê¸°ì¡´ í´ë§ì´ ìˆë‹¤ë©´ ì¤‘ì§€
      if (currentPollingInterval) {
          clearInterval(currentPollingInterval);
          currentPollingInterval = null;
      }

      setMsg("â³ AIë¡œ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... (1/2: ì‘ì—… ì˜ˆì•½)", "#333");
      
      const extractUrl = ENDPOINT + 
          `?action=extract&url=${encodeURIComponent(url)}`;
      
      // JSONP ë°©ì‹ìœ¼ë¡œ ì²« ìš”ì²­ ì‹œì‘, ì½œë°±ì€ handleStartResponse
      loadJsonpScript(extractUrl, 'handleStartResponse'); // CHANGED: ì½œë°± í•¨ìˆ˜ëª…ì„ ëª…ì‹œ
  }

  /**
   * 1ë‹¨ê³„ ì‘ë‹µ ì²˜ë¦¬: Job IDë¥¼ ë°›ì•„ í´ë§ ì‹œì‘
   */
  window.handleStartResponse = function(response) { // CHANGED: ì „ì—­ í•¨ìˆ˜ë¡œ ì„ ì–¸
      const payload = (response && typeof response === 'object' && 'data' in response) ? (response.data || {}) : (response || {});

      if (payload && payload.jobId) {
          const jobId = payload.jobId;
          setMsg(`â³ AIë¡œ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... (2/2: ê²°ê³¼ í™•ì¸ ì¤‘ Job ID: ${jobId})`, "#333");
          
          // 2ë‹¨ê³„: í´ë§ ì‹œì‘
          pollForResults(jobId);
      } else {
          setMsg(`âŒ ì‘ì—… ì˜ˆì•½ ì‹¤íŒ¨: ${payload.error || 'ì‘ë‹µ ì˜¤ë¥˜'}`, "red");
      }
      delete window.handleStartResponse; // ì‚¬ìš© í›„ ì‚­ì œ (ì„ íƒ)
  }

  /**
   * 2ë‹¨ê³„: ê²°ê³¼ê°€ ë‚˜ì˜¬ ë•Œê¹Œì§€ ì£¼ê¸°ì ìœ¼ë¡œ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
   */
  function pollForResults(jobId) {
      const checkUrl = ENDPOINT + 
          `?action=check&jobId=${jobId}`;
      
      // í´ë§ ê°„ê²© ì„¤ì •
      const intervalId = setInterval(() => {
          // JSONP ìš”ì²­ ì‹œ, ì½œë°± í•¨ìˆ˜ëª…ì„ handlePollResponseë¡œ ê³ ì •
          loadJsonpScript(checkUrl, 'handlePollResponse'); 
      }, POLLING_INTERVAL);
      
      currentPollingInterval = intervalId;
  }

  /**
   * 2ë‹¨ê³„ ì‘ë‹µ ì²˜ë¦¬: ìƒíƒœ í™•ì¸ ë° ìµœì¢… ê²°ê³¼ í‘œì‹œ
   */
  window.handlePollResponse = function(response) { // CHANGED: ì „ì—­ í•¨ìˆ˜ë¡œ ì„ ì–¸
      const jobResult = response.data;
      if (!jobResult) return; // ìœ íš¨í•˜ì§€ ì•Šì€ ì‘ë‹µ ë¬´ì‹œ

      // ìƒíƒœ ì—…ë°ì´íŠ¸
      setMsg(`... ì‘ì—… ì§„í–‰ ì¤‘: ${jobResult.status}`, "#333");

      // ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆê±°ë‚˜ ì‹¤íŒ¨í–ˆì„ ë•Œ
      if (jobResult.status === "complete" || jobResult.status === "failed") {
          clearInterval(currentPollingInterval); // í´ë§ ì¤‘ì§€
          currentPollingInterval = null;
          
          // ìµœì¢… ê²°ê³¼ ì²˜ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ
          handleFinalResult(jobResult); 
          delete window.handlePollResponse; // ì‚¬ìš© í›„ ì‚­ì œ
      }
  }

  /**
   * 3ë‹¨ê³„: ìµœì¢… ê²°ê³¼ ë°ì´í„°ë¥¼ DOMì— ë°˜ì˜
   */
  function handleFinalResult(jobResult) {
      if (jobResult.status === "complete" && jobResult.ok) {
          setMsg("âœ… ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì—¬ í•„ë“œì— ìë™ ì…ë ¥í–ˆìŠµë‹ˆë‹¤.", "#148914");
          
          const payload = jobResult.data || {};
          console.log('[extract payload]', payload);
          say && say('extract ok keys=' + (payload.data ? Object.keys(payload.data).length : 0));
          const data = payload.data || {}; // Apps Scriptì—ì„œ data: { ok: true, data: {...}} í˜•íƒœë¡œ ë°˜í™˜

          // --------------------------------------------------------
          // ê¸°ì¡´ ì½”ë“œì˜ ë°ì´í„° ë°˜ì˜ ë¡œì§ (payload ëŒ€ì‹  data ì‚¬ìš©)
          // --------------------------------------------------------
          
          // ê¸°ë³¸ ì¸ì /ì¥ì†Œ
          $('groomFather').value = data.groomFather || "";
          $('groomMother').value = data.groomMother || "";
          $('groomOrder').valueÂ  = data.groomOrderÂ  || "";
          $('groomName').valueÂ  Â = data.groomNameÂ  Â || "";
          $('brideFather').value = data.brideFather || "";
          $('brideMother').value = data.brideMother || "";
          $('brideOrder').valueÂ  = data.brideOrderÂ  || "";
          $('brideName').valueÂ  Â = data.brideNameÂ  Â || "";

          // í˜•ì œê´€ê³„ ì»¤ìŠ¤í…€ ì…€ë ‰íŠ¸ ë¼ë²¨ ì¬ë™ê¸°í™”
          syncCustomSelect('groomOrder');
          syncCustomSelect('brideOrder');

          // ë‚ ì§œ/ì‹œê°„
          const dateRaw = data.eventDate || data.date || "";
          const timeRaw = data.eventTime || data.time || "";
          const dtFromTime = extractDateAndTimeKR(timeRaw);
          const dtFromDate = extractDateAndTimeKR(dateRaw);
          const finalDate = dtFromTime.date || dtFromDate.date || dateRaw || "";
          const finalTime = normalizeToHHMM(timeRaw) || dtFromTime.time || normalizeToHHMM(dtFromDate.time||"") || "";
          setDateDisplay(finalDate);
          setTimeDisplay(finalTime);

          // ì¥ì†Œ
          $('venueAddr').valueÂ  Â = data.venueAddr || "";
          $('venueDetail').value = data.venueÂ  Â  Â  Â || data.venueDetail || "";

          // ì—°ë½ì²˜/ê³„ì¢Œ ì œì•ˆ ì €ì¥(Detailì—ì„œ ì‚¬ìš©)
          const CONTACT_KEYS = ["groomPhone","bridePhone","groomFatherPhone","groomMotherPhone","brideFatherPhone","brideMotherPhone"];
          const ACCOUNT_KEYS = ["groomBank","groomAccount","brideBank","brideAccount","groomFatherBank","groomFatherAccount","groomMotherBank","groomMotherAccount","brideFatherBank","brideFatherAccount","brideMotherBank","brideMotherAccount"];
          const ai={}; CONTACT_KEYS.concat(ACCOUNT_KEYS).forEach((k)=>{ if(data[k]) ai[k]=data[k]; });
          sessionStorage.setItem('ai-suggestions', JSON.stringify(ai));

      } else {
          setMsg("âŒ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (Error: " + (jobResult.error || 'Unknown') + ")", "red");
      }
  }


Â  /* === 5) ì»¤ìŠ¤í…€ ì…€ë ‰íŠ¸ ë¼ë²¨ ë™ê¸°í™” (ê¸°ì¡´ ë¡œì§ ìœ ì§€) === */
Â  function syncCustomSelect(selectId){
Â  Â  const sel = $(selectId);
Â  Â  const wrap = document.querySelector(`.cselect[data-for="${selectId}"]`);
Â  Â  if(!sel || !wrap || !wrap.dataset.built) return;
Â  Â  const btnÂ  = wrap.querySelector('.cselect__btn');
Â  Â  const list = wrap.querySelector('.cselect__list');
Â  Â  const optÂ  = sel.selectedOptions && sel.selectedOptions[0];
Â  Â  if(btn && opt){
Â  Â  Â  if(btn.firstChild) btn.firstChild.nodeValue = opt.textContent || 'ì„ íƒ';
Â  Â  Â  else btn.prepend(document.createTextNode(opt.textContent || 'ì„ íƒ'));
Â  Â  }
Â  Â  if(list){
Â  Â  Â  [...list.children].forEach(n=>{
Â  Â  Â  Â  const v = n.getAttribute('data-value');
Â  Â  Â  Â  n.setAttribute('aria-selected', String(v === sel.value));
Â  Â  Â  });
Â  Â  }
Â  Â  sel.dispatchEvent(new Event('change'));
Â  }

Â  // ì»¤ìŠ¤í…€ ì…€ë ‰íŠ¸ ì˜µì…˜ DOM ìƒì„± ë° ì´ë²¤íŠ¸ ì²˜ë¦¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
Â  function buildCustomSelect(selectId){
Â  Â  const selÂ  = document.getElementById(selectId);
Â  Â  const wrap = document.querySelector(`.cselect[data-for="${selectId}"]`);
Â  Â  if(!sel || !wrap) return;
Â  Â  const list = wrap.querySelector('.cselect__list');
Â  Â  const btnÂ  = wrap.querySelector('.cselect__btn');
Â  Â  if(!list || !btn) return;

Â  Â  // 1) ì˜µì…˜ DOM ìƒì„±(ì´ˆê¸° 1íšŒ)
Â  Â  if(!wrap.dataset.built){
Â  Â  Â  Array.from(sel.options).forEach(opt=>{
Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  div.className = 'cselect__option';
Â  Â  Â  Â  div.setAttribute('role','option');
Â  Â  Â  Â  div.setAttribute('data-value', opt.value);
Â  Â  Â  Â  div.textContent = opt.textContent || opt.value || 'ì„ íƒ';
Â  Â  Â  Â  if(opt.value === sel.value) div.setAttribute('aria-selected','true');
Â  Â  Â  Â  else div.setAttribute('aria-selected','false');
Â  Â  Â  Â  list.appendChild(div);
Â  Â  Â  });
Â  Â  Â  wrap.dataset.built = '1';
Â  Â  }

Â  Â  // 2) ë²„íŠ¼ ë¼ë²¨ ë™ê¸°í™”
Â  Â  const cur = sel.selectedOptions && sel.selectedOptions[0];
Â  Â  btn.firstChild ? (btn.firstChild.nodeValue = cur ? cur.textContent : 'ì„ íƒ')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â : btn.prepend(document.createTextNode(cur ? cur.textContent : 'ì„ íƒ'));

Â  Â  // 3) ì—´ê¸°/ë‹«ê¸° í† ê¸€
Â  Â  function closeList(){ list.classList.remove('is-open'); btn.setAttribute('aria-expanded','false'); }
Â  Â  btn.addEventListener('click', (e)=>{
Â  Â  Â  e.stopPropagation();
Â  Â  Â  const willOpen = !list.classList.contains('is-open');
Â  Â  Â  // ë‹¤ë¥¸ ì—´ë¦° ì…€ë ‰íŠ¸ ë‹«ê¸°
Â  Â  Â  document.querySelectorAll('.cselect__list.is-open').forEach(x=>{
Â  Â  Â  Â  if(x !== list) x.classList.remove('is-open');
Â  Â  Â  });
Â  Â  Â  document.querySelectorAll('.cselect__btn[aria-expanded="true"]').forEach(x=>{
Â  Â  Â  Â  if(x !== btn) x.setAttribute('aria-expanded','false');
Â  Â  Â  });

Â  Â  Â  if(willOpen){ list.classList.add('is-open'); btn.setAttribute('aria-expanded','true'); }
Â  Â  Â  else closeList();
Â  Â  });
Â  Â  document.addEventListener('click', (e)=>{
Â  Â  Â  if(!wrap.contains(e.target)) closeList();
Â  Â  });

Â  Â  // 4) ì˜µì…˜ í´ë¦­ â†’ ê°’ ë°˜ì˜
Â  Â  list.addEventListener('click', (e)=>{
Â  Â  Â  const optDiv = e.target.closest('.cselect__option'); if(!optDiv) return;
Â  Â  Â  const v = optDiv.getAttribute('data-value') || '';
Â  Â  Â  sel.value = v;
Â  Â  Â  syncCustomSelect(selectId); // ë³€ê²½ëœ ê°’ìœ¼ë¡œ aria-selected, ë²„íŠ¼ ë¼ë²¨ ë“± ê°±ì‹ 
Â  Â  Â  closeList();
Â  Â  });

Â  Â  // 5) í‚¤ë³´ë“œ ì ‘ê·¼ì„±(ê°„ë‹¨ ë²„ì „)
Â  Â  btn.addEventListener('keydown', (e)=>{
Â  Â  Â  if(e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' '){
Â  Â  Â  Â  e.preventDefault(); list.classList.add('is-open'); btn.setAttribute('aria-expanded','true');
Â  Â  Â  Â  const selDiv = list.querySelector('.cselect__option[aria-selected="true"]') || list.firstElementChild;
Â  Â  Â  Â  selDiv && selDiv.scrollIntoView({block:'nearest'});
Â  Â  Â  }
Â  Â  });
Â  }

Â  /* === 6) DOM ì¤€ë¹„ === */
Â  document.addEventListener('DOMContentLoaded', ()=>{
Â  Â  // Guard ë°°ì§€ê°€ ìˆìœ¼ë©´ í¬ì¸í„° ê°€ì ¸ì˜¤ê¸°(ì„ íƒ)
Â  Â  guardBadge = document.querySelector('body > div[style*="Guard"]') || null;

Â  Â  // ì„¸ê·¸ë¨¼íŠ¸ í† ê¸€ ê¸°ë³¸ ë°”ì¸ë”©(ìŠ¤ëª°ì›¨ë”©/í™”í™˜ ë“±)
Â  Â  document.addEventListener('click', (e)=>{
Â  Â  Â  const b = e.target.closest('.seg__btn'); if(!b) return;
Â  Â  Â  const seg = b.closest('.seg'); const hiddenId = seg?.getAttribute('data-for');
Â  Â  Â  const hidden = hiddenId ? $(hiddenId) : null;
Â  Â  Â  seg.querySelectorAll('.seg__btn').forEach(x=>{ x.setAttribute('aria-pressed','false'); x.classList.remove('is-selected'); });
Â  Â  Â  b.setAttribute('aria-pressed','true'); b.classList.add('is-selected');
Â  Â  Â  if(hidden) hidden.value = b.dataset.value || '';
Â  Â  });

Â  Â  // ìˆ˜ê¸° ì…ë ¥ í† ê¸€
Â  Â  (function(){
Â  Â  Â  const noInviteEl = $('noInvite');
Â  Â  Â  const block = $('inviteUrlBlock');
Â  Â  Â  const btnCheck = $('btnCheck');
Â  Â  Â  function updateInviteMode(){
Â  Â  Â  Â  const off = noInviteEl.checked;
Â  Â  Â  Â  block.classList.toggle('hidden', off);
Â  Â  Â  Â  btnCheck.classList.toggle('hidden', off);
Â  Â  Â  Â  if(off){ $('inviteUrl').value=''; }
Â  Â  Â  }
Â  Â  Â  noInviteEl.addEventListener('change', updateInviteMode);
Â  Â  Â  updateInviteMode();
Â  Â  })();

Â  Â  // AI ë²„íŠ¼ í´ë¦­ ë¦¬ìŠ¤ë„ˆ (CHANGED)
Â  Â  $('btnCheck').addEventListener('click', async ()=>{
Â  Â  Â  const url = ($('inviteUrl').value || '').trim();
Â  Â  Â  if(!url){ setMsg("âŒ ì²­ì²©ì¥ URLì„ ì…ë ¥í•˜ì„¸ìš”.", "red"); return; }
Â  Â  Â  
      // ğŸš¨ ë¹„ë™ê¸° ì¶”ì¶œ ì‘ì—… ì‹œì‘!
Â  Â  Â  startExtraction(url);
Â  Â  });

Â  Â  // ADDED: ì»¤ìŠ¤í…€ ì…€ë ‰íŠ¸ ì´ˆê¸°í™”
Â  Â  buildCustomSelect('groomOrder');
Â  Â  buildCustomSelect('brideOrder');

Â  });

})();
</script>
</body>
</html>

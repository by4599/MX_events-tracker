<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ê²½ì‚¬ ì •ë³´ ì œì¶œ</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:24px;color:#111}
.card{max-width:680px;margin:0 auto;padding:20px;border:1px solid #ddd;border-radius:12px}
label{display:block;margin:12px 0 4px;font-weight:600}
input,select{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;box-sizing:border-box}
.row{display:flex;gap:8px}
.btn{padding:12px 16px;border:0;border-radius:8px;background:#111;color:#fff;cursor:pointer}
.hint{color:#666;font-size:12px;margin-top:4px}
.success{color:#0a0;margin-top:12px}
.error{color:#c00;margin-top:12px}
.hidden{display:none}
pre{white-space:pre-wrap;border:1px solid #ccc;padding:12px;border-radius:8px;background:#f9f9f9}
</style>
</head>
<body>
  <div class="card">
    <h2>ê²½ì‚¬ ì •ë³´ ì œì¶œ</h2>

    <form id="form">
      <!-- ê¸°ë³¸ -->
      <label>ì„±ëª… *</label><input name="name" required>
      <label>ì¬ì§/í‡´ì§ *</label>
      <select name="empStatus" required><option value="">ì„ íƒ</option><option>ì¬ì§</option><option>í‡´ì§</option></select>
      <label>ê·¼ë¬´ ë¶€ì„œ *</label><input name="deptWhenEmployed" required>
      <label>í˜„ ì§ì¥/ì§ì±… *</label><input name="currentJobTitle" required>
      <label>ì²­íƒê¸ˆì§€ë²• ì ìš© ì—¬ë¶€ *</label>
      <select name="antiGraft" required><option value="">ì„ íƒ</option><option>ëŒ€ìƒ</option><option>ë¹„ëŒ€ìƒ</option></select>

      <!-- ì‹ ë‘/ì‹ ë¶€ì¸¡ -->
      <label>ì‹ ë‘/ì‹ ë¶€ì¸¡ *</label>
      <div class="row">
        <label><input type="radio" name="side" value="groom" required> ì‹ ë‘ì¸¡</label>
        <label><input type="radio" name="side" value="bride" required> ì‹ ë¶€ì¸¡</label>
      </div>

      <!-- ê°€ì¡± -->
      <label>ì‹ ë‘ ì•„ë²„ì§€ *</label><input name="groomFather" required>
      <label>ì‹ ë‘ ì–´ë¨¸ë‹ˆ *</label><input name="groomMother" required>
      <label>ì‹ ë‘ ì´ë¦„ *</label><input name="groomName" required>
      <label>ì‹ ë¶€ ì•„ë²„ì§€ *</label><input name="brideFather" required>
      <label>ì‹ ë¶€ ì–´ë¨¸ë‹ˆ *</label><input name="brideMother" required>
      <label>ì‹ ë¶€ ì´ë¦„ *</label><input name="brideName" required>

      <!-- í˜•ì œ/ìë§¤ -->
      <label>í˜•ì œ/ìë§¤ ìˆœì„œ *</label>
      <select name="order" id="order" required>
        <option value="">ì„ íƒ</option>
        <option>ì¥ë‚¨</option><option>ì°¨ë‚¨</option><option>ì‚¼ë‚¨</option>
        <option>ì¥ë…€</option><option>ì°¨ë…€</option><option>ì‚¼ë…€</option>
        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
      </select>
      <input type="text" name="orderEtc" id="orderEtc" class="hidden" placeholder="ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)">

      <!-- ê³„ì¢Œ/ì—°ë½ì²˜ -->
      <label>ì¶•ì˜ê³„ì¢Œ * <span class="hint">(ë³¸ì¸ ê³„ì¢Œ)</span></label><input name="bankNumber" required placeholder="000-0000-0000-00">
      <label>ì€í–‰ *</label>
      <select name="bankName" required><option value="">ì„ íƒ</option><option>êµ­ë¯¼</option><option>ì‹ í•œ</option><option>ìš°ë¦¬</option><option>í•˜ë‚˜</option><option>ë†í˜‘</option><option>ê¸°ì—…</option><option value="ê¸°íƒ€">ê¸°íƒ€</option></select>
      <label>ì—°ë½ì²˜ *</label><input id="phone" name="phone" required placeholder="010-1234-5678">

      <!-- AIì—ì„œ ë„˜ì–´ì˜¨ ì˜ˆì‹ ì •ë³´ -->
      <label>ì˜ˆì‹ì¼ *</label><input type="date" id="eventDate" name="eventDate" required>
      <label>ì˜ˆì‹ ì‹œê°„ *</label><input type="time" id="eventTime" name="eventTime" step="600" required>
      <label>ì‹ì¥(ìƒì„¸) *</label><input name="venue" required placeholder="ì˜ˆ: â—‹â—‹ì›¨ë”©í™€ 3ì¸µ â—‹â—‹í™€">
      <label>ì‹ì¥ ì£¼ì†Œ *</label><input id="venueAddr" name="venueAddr" required placeholder="ë„ë¡œëª… ì£¼ì†Œ">

      <div class="hint">ì œì¶œì€ ê²Œì‹œ ìš”ì²­ì´ë©°, ì‹¤ì œ ê²Œì‹œëŠ” ë‹´ë‹¹ìê°€ ì§„í–‰í•©ë‹ˆë‹¤.</div>
      <div style="margin-top:8px"><label><input type="checkbox" id="consent" required> ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤</label></div>

      <button type="submit" class="btn" style="margin-top:12px">ì œì¶œ</button>
      <p id="msg"></p>
    </form>

    <!-- ê²Œì‹œíŒ ë¯¸ë¦¬ë³´ê¸° -->
    <div id="previewBox" class="hidden">
      <h3>ğŸ“ ê²Œì‹œíŒ ì•ˆë‚´ë¬¸ ë¯¸ë¦¬ë³´ê¸°</h3>
      <pre id="previewText"></pre>
    </div>
  </div>

<script>
const ENDPOINT = '<<<ì—¬ê¸°ì— Apps Script ì›¹ì•± URL /exec>>>';
// ë™ì˜ ì²´í¬ ë¯¸ë¦¬ í™•ì¸
if (localStorage.getItem('consent') !== 'true') {
  location.href = 'privacy.html';
}

// inviteì—ì„œ ì¶”ì¶œí•œ ê°’ ì£¼ì…
(function prefillFromInvite(){
  try {
    const raw = localStorage.getItem('inviteExtract');
    if (!raw) return;
    const { eventDate, eventTime, venue } = JSON.parse(raw);
    if (eventDate) document.getElementById('eventDate').value = eventDate;
    if (eventTime) document.getElementById('eventTime').value = eventTime;
    if (venue)     document.querySelector('input[name=venue]').value = venue;
  } catch(_) {}
})();

// ê¸°íƒ€ ì„ íƒ ì‹œ ì…ë ¥ì¹¸ í‘œì‹œ
const orderSel = document.getElementById('order');
const orderEtc = document.getElementById('orderEtc');
orderSel.addEventListener('change', ()=> orderEtc.classList.toggle('hidden', orderSel.value !== 'ê¸°íƒ€'));

// í° í•˜ì´í”ˆ í‘œì‹œ
document.getElementById('phone').addEventListener('input', e=>{
  let v = e.target.value.replace(/[^0-9]/g,'');
  if (v.length >= 10) v = v.replace(/(\d{3})(\d{3,4})(\d{4})/, '$1-$2-$3');
  e.target.value = v;
});

// ì œì¶œ ì²˜ë¦¬
document.getElementById('form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const f = e.target;
  const date = document.getElementById('eventDate').value;
  const time = document.getElementById('eventTime').value;
  const eventDateTime = (date && time) ? `${date}T${time}` : '';

  const formData = new FormData(f);
  const payload = Object.fromEntries(formData.entries());
  payload.eventType = 'ê²½ì‚¬';
  payload.eventDateTime = eventDateTime;
  payload.consent = true;
  if (payload.order === 'ê¸°íƒ€') payload.order = payload.orderEtc;

  const msg = document.getElementById('msg');
  msg.textContent = 'ì „ì†¡ ì¤‘...'; msg.className='';

  try {
    const res = await fetch(ENDPOINT, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });

    // ë°©ì–´ì  íŒŒì‹±
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); }
    catch(e){
      console.error('ì„œë²„ ì‘ë‹µ ì›ë¬¸:', text.slice(0,400));
      msg.textContent = 'ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨(HTML ìˆ˜ì‹ ). ì›¹ì•± ë°°í¬ URL(/exec)Â·ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.';
      msg.className = 'error';
      return;
    }

    if (data.ok) {
      msg.textContent = 'ì œì¶œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹´ë‹¹ìê°€ í™•ì¸ í›„ ì—°ë½ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.';
      msg.className = 'success';

      if (data.preview) {
        document.getElementById('previewBox').classList.remove('hidden');
        document.getElementById('previewText').textContent = data.preview;
      }

      f.reset();
      orderEtc.classList.add('hidden');
      // í•œ ë²ˆ ì‚¬ìš©í•œ ì´ˆê¹ƒê°’ì€ ì •ë¦¬ (ì„ íƒ)
      // localStorage.removeItem('inviteExtract');
      // localStorage.removeItem('inviteUrl');
    } else {
      msg.textContent = 'ì˜¤ë¥˜: ' + (data.error || 'ì œì¶œ ì‹¤íŒ¨');
      msg.className = 'error';
    }
  } catch (err) {
    msg.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + err.message;
    msg.className = 'error';
  }
});
</script>
</body>
</html>

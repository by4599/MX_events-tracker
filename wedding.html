<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>청첩장 AI 분석</title>
  <style>
    body {
      font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      margin:0;
      padding:16px;
      background:#f9f9f9;
      color:#111;
    }
    .card {
      max-width:420px;
      margin:0 auto;
      background:#fff;
      padding:20px;
      border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,.1);
    }
    h1 { font-size:20px; margin:0 0 12px 0; }
    label { font-size:14px; color:#555; }
    input[type=text] {
      width:100%;
      padding:10px;
      border:1px solid #ccc;
      border-radius:8px;
      font-size:15px;
      box-sizing:border-box;
    }
    button {
      width:100%;
      padding:12px;
      margin-top:14px;
      background:#0055ff;
      color:#fff;
      border:none;
      border-radius:8px;
      font-size:16px;
      cursor:pointer;
    }
    button:disabled {
      background:#ccc;
      cursor:not-allowed;
    }
    .msg {
      margin-top:12px;
      font-size:14px;
      color:#333;
      white-space:pre-wrap;
      word-break:break-all;
    }
    .footer {
      margin-top:30px;
      font-size:12px;
      color:#777;
      text-align:center;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>💌 모바일 청첩장 AI 분석</h1>
    <label>청첩장 URL</label>
    <input type="text" id="urlInput" placeholder="https://..." />
    <button id="btnCheck">AI로 예식 정보 확인</button>
    <div id="msg" class="msg"></div>
    <button id="btnNext" style="display:none;background:#009966;">다음 단계로 이동</button>
  </div>
  <div class="footer">
    Powered by Google Apps Script + Gemini API
  </div>

  <script>
    const btnCheck = document.getElementById("btnCheck");
    const btnNext = document.getElementById("btnNext");
    const msg = document.getElementById("msg");
    const input = document.getElementById("urlInput");

    btnCheck.onclick = async () => {
      const url = input.value.trim();
      if (!url) {
        msg.textContent = "❌ URL을 입력해주세요.";
        return;
      }

      msg.textContent = "⏳ 분석 중입니다. 잠시만 기다려주세요...";
      btnCheck.disabled = true;
      btnNext.style.display = "none";

      try {
        // ⚠️ 배포한 Apps Script 웹앱 URL로 교체하세요.
        const endpoint = "https://script.google.com/macros/s/AKfycbxxxxxxxxxxxxxxxxxxxxxx/exec";
        const apiUrl = `${endpoint}?action=extract&url=${encodeURIComponent(url)}`;
        const res = await fetch(apiUrl);
        const data = await res.json();

        if (!data.ok) {
          msg.textContent = "❌ 분석 실패: " + (data.error || "원인 불명");
          btnCheck.disabled = false;
          return;
        }

        const payload = data.data || {};
        msg.textContent =
          "✅ 분석 완료\n\n" +
          Object.entries(payload)
            .filter(([k,v]) => v)
            .map(([k,v]) => `${k}: ${v}`)
            .join("\n");

        // ✅ 추가: Wedding_detail.html에서 자동 프리필용으로 결과 저장
        const aiSuggestions = {
          groomFatherPhone: payload.groomFatherPhone || "",
          groomMotherPhone: payload.groomMotherPhone || "",
          brideFatherPhone: payload.brideFatherPhone || "",
          brideMotherPhone: payload.brideMotherPhone || "",
          groomPhone:       payload.groomPhone       || "",
          bridePhone:       payload.bridePhone       || "",
          venueTel:         payload.venueTel         || "",

          groomFatherBank:    payload.groomFatherBank    || "",
          groomFatherAccount: payload.groomFatherAccount || "",
          groomMotherBank:    payload.groomMotherBank    || "",
          groomMotherAccount: payload.groomMotherAccount || "",
          brideFatherBank:    payload.brideFatherBank    || "",
          brideFatherAccount: payload.brideFatherAccount || "",
          brideMotherBank:    payload.brideMotherBank    || "",
          brideMotherAccount: payload.brideMotherAccount || "",
          groomBank:          payload.groomBank          || "",
          groomAccount:       payload.groomAccount       || "",
          brideBank:          payload.brideBank          || "",
          brideAccount:       payload.brideAccount       || ""
        };
        localStorage.setItem("ai_suggestions", JSON.stringify(aiSuggestions));
        console.log("✅ 저장된 ai_suggestions:", aiSuggestions);

        btnCheck.disabled = false;
        btnNext.style.display = "block";
      } catch (err) {
        console.error(err);
        msg.textContent = "❌ 네트워크 오류 또는 API 응답 실패: " + err.message;
        btnCheck.disabled = false;
      }
    };

    btnNext.onclick = () => {
      location.href = "wedding_detail.html";
    };
  </script>
</body>
</html>

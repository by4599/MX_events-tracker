<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ê²°í˜¼ì‹ ì •ë³´ ì…ë ¥</title>
<style>
/* ================== ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ================== */
body{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  margin:0; padding:16px; background:#f9f9f9; color:#111;
}
.card{
  max-width:420px; margin:0 auto; background:#fff; padding:16px;
  border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.1);
}
h2{ margin-top:0; font-size:18px; }
label{ display:block; margin:8px 0 4px; font-weight:600; font-size:14px; }

/* ================== í¼ ì»¨íŠ¸ë¡¤ ê³µí†µ ================== */
input[type="text"], input[type="url"], select{
  width:100%; padding:10px 12px; font-size:14px;
  border:1.5px solid #ddd; border-radius:8px; background:#fff;
  transition:.2s; outline:none; box-sizing:border-box;
}
input::placeholder{ color:#aaa; font-size:13px; }
input:focus, select:focus{ border-color:#111; box-shadow:0 0 0 3px rgba(17,17,17,.08); }

.row{ display:flex; gap:6px; }
.btn{ padding:10px 12px; border:0; border-radius:6px; cursor:pointer; font-weight:600; font-size:14px; }
.btn.primary{ background:#111; color:#fff; width:100%; margin-top:12px; }
.section{ margin-top:16px; padding-top:12px; border-top:1px solid #eee; }
.msg{ margin-top:8px; font-size:13px; font-weight:600; white-space:pre-line; }
.msg[style*="red"]{ color:#C82D2D !important; }
.msg[style*="green"]{ color:#00954B !important; }

/* ================== í† ê¸€ ìŠ¤ìœ„ì¹˜ ================== */
.toggle-wrapper{ display:flex; align-items:center; justify-content:space-between; margin:12px 0; font-size:14px; }
.switch{ position:relative; display:inline-block; width:42px; height:24px; }
.switch input{ opacity:0; width:0; height:0; }
.slider{ position:absolute; inset:0; cursor:pointer; background:#ccc; border-radius:24px; transition:.3s; }
.slider:before{ content:""; position:absolute; height:18px; width:18px; left:3px; bottom:3px; background:#fff; border-radius:50%; transition:.3s; }
.switch input:checked + .slider{ background:#111; }
.switch input:checked + .slider:before{ transform:translateX(18px); }

/* ================== ì»¤ìŠ¤í…€ ì…€ë ‰íŠ¸ ================== */
.native-select--hidden{ position:absolute !important; inset:0; opacity:0; pointer-events:none; height:0; width:0; }
.cselect{ position:relative; }
.cselect__btn{
  width:100%; padding:10px 12px; font-size:14px;
  border:1.5px solid #ddd; border-radius:8px; background:#fff;
  display:flex; align-items:center; justify-content:space-between;
}
.cselect__btn:focus{ border-color:#111; box-shadow:0 0 0 3px rgba(17,17,17,.08); }
.cselect__arrow{
  width:16px; height:16px; flex:0 0 16px;
  mask:url("data:image/svg+xml;utf8,<svg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>") no-repeat center / contain;
  background:#111; opacity:.9;
}
.cselect__list{
  position:absolute; z-index:20; left:0; right:0; top:calc(100% + 6px);
  background:#fff; border:1px solid #e5e5e5; border-radius:10px;
  box-shadow:0 6px 16px rgba(0,0,0,.08); max-height:240px; overflow:auto; padding:6px; display:none;
}
.cselect__list.is-open{ display:block; }
.cselect__option{ padding:10px 10px; border-radius:8px; font-size:14px; cursor:pointer; }
.cselect__option[aria-selected="true"]{ background:#111; color:#fff; }
.cselect__option:hover{ background:#f2f2f2; }

/* ================== ì„¸ê·¸ë¨¼íŠ¸ ë²„íŠ¼ ================== */
.seg{ display:flex; gap:6px; }
.seg__btn{
  flex:1; padding:10px 12px; border:1.5px solid #ddd; border-radius:6px;
  background:#fff; font-weight:600; font-size:14px; cursor:pointer;
}
.seg__btn[aria-pressed="true"], .seg__btn.is-selected{ background:#111; color:#fff; border-color:#111; }

.hidden{ display:none !important; }

/* ================== ë‚ ì§œ/ì‹œê°„ í‘œì‹œ í•„ë“œ ================== */
.field{ position:relative; }
.display-input{ padding-right:40px; cursor:pointer; background:#fff; }
.display-input[aria-invalid="true"]{ border-color:#f33; box-shadow:0 0 0 3px rgba(255,51,51,.12); }
.input-icon{
  position:absolute; right:12px; top:50%; transform:translateY(-50%);
  width:18px; height:18px; opacity:.9; pointer-events:none;
  background-size:contain; background-repeat:no-repeat; background-position:center;
}

/* ================== ëª¨ë‹¬(ë‹¬ë ¥/ì‹œê°„ í”¼ì»¤) ê³µí†µ ================== */
.picker-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:1000; }
.picker{
  position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
  width:min(420px,92vw); background:#fff; border-radius:12px;
  box-shadow:0 20px 48px rgba(0,0,0,.24); display:none; z-index:1001;
}
.picker__hdr{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #eee; }
.picker__title{ font-weight:700; }
.picker__body{ padding:12px; }
.picker__ftr{ display:flex; gap:8px; padding:12px; border-top:1px solid #eee; }
.picker__btn{ flex:1; padding:10px 12px; border-radius:8px; border:1.5px solid #ddd; background:#fff; font-weight:700; cursor:pointer; }
.picker__btn.primary{ background:#111; color:#fff; border-color:#111; }
.icon-btn{ border:1.5px solid #ddd; background:#fff; border-radius:8px; width:36px; height:32px; cursor:pointer; }

/* ================== ë‹¬ë ¥ í—¤ë” ë¼ì¸ ================== */
.cal-topline{ display:flex; align-items:center; justify-content:space-between; width:100%; gap:8px; }
.cal-left{ font-weight:800; font-size:14px; color:#111; }
.cal-ym{ font-weight:800; font-size:18px; letter-spacing:.3px; }

/* ================== ë‹¬ë ¥ ìš”ì¼/ë‚ ì§œ ê·¸ë¦¬ë“œ ================== */
.cal-head{
  display:grid; grid-template-columns:repeat(7,1fr); gap:4px;
  margin-bottom:6px; font-size:14px; font-weight:700; text-align:center;
}
.cal-head .sun{ color:#C82D2D; }
.cal-head .sat{ color:#142396; }
.cal-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }

/* ë‚ ì§œ ì…€ */
.cal-day{
  padding:10px 0; text-align:center; border-radius:8px; border:1px solid transparent;
  cursor:pointer; background:#fff; color:#111; font-weight:600;
}
.cal-day:hover{ background:#f5f5f5; }
.cal-day.out{ color:#bbb; cursor:default; background:transparent; }
.cal-day.today{ border-color:#111; }

/* ì„ íƒ ìƒíƒœ */
.cal-day.sel{ background:#111; color:#fff !important; }
.cal-day.sun{ color:#C82D2D !important; }
.cal-day.sat{ color:#142396 !important; }

/* ================== ì‹œê°„ í”¼ì»¤: 3ì—´ ì„¸ë¡œ ================== */
.time-wrap{ display:flex; gap:8px; }
.time-col{
  flex:1; max-height:260px; overflow-y:auto; overflow-x:hidden;
  border:1px solid #eee; border-radius:12px; background:#fafafa; padding:8px;
}
.time-col--ampm{ flex:.9; }
.time-col::-webkit-scrollbar{ display:none; }
.time-col{ scrollbar-width:none; -ms-overflow-style:none; }
.time-item{
  width:100%; padding:10px 0; margin:4px 0; border-radius:10px;
  cursor:pointer; text-align:center; border:1.5px solid transparent;
  background:#fff; font-weight:600;
}
.time-item:hover{ background:#f5f5f5; }
.time-item.sel{ background:#111; color:#fff; border-color:#111; }

/* ë³´ì¡° ì•ˆë‚´ë¬¸ */
.hint { color:#8a8a8a; font-size:12px; margin-top:6px; display:block; }

/* a11y */
.sr-only{
  position:absolute !important; width:1px; height:1px; padding:0; margin:-1px;
  overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
}
</style>
</head>
<body>
<div class="card">
  <h2>ê²°í˜¼ì‹ ê¸°ë³¸ ì •ë³´ ì…ë ¥</h2>

  <!-- ì²­ì²©ì¥ URL -->
  <div id="inviteUrlBlock">
    <label for="inviteUrl">ëª¨ë°”ì¼ ì²­ì²©ì¥ URL</label>
    <input id="inviteUrl" type="url" placeholder="https://..." />
  </div>

  <!-- ìˆ˜ê¸° ì…ë ¥ í† ê¸€ -->
  <div class="toggle-wrapper">
    <span id="noInviteLabel">ëª¨ë°”ì¼ ì²­ì²©ì¥ ì—†ìŒ (ìˆ˜ê¸° ì…ë ¥)</span>
    <label class="switch">
      <input type="checkbox" id="noInvite" aria-labelledby="noInviteLabel" />
      <span class="slider"></span>
    </label>
  </div>

  <button class="btn primary" id="btnCheck">AIë¡œ ì˜ˆì‹ ì •ë³´ í™•ì¸</button>
  <div id="msg" class="msg"></div>

  <!-- ì‹ ë‘ì¸¡ -->
  <div class="section">
    <h3>ì‹ ë‘ì¸¡</h3>
    <label for="groomFather">í˜¼ì£¼ ì•„ë²„ì§€ ì„±í•¨ *</label>
    <input id="groomFather" type="text" />
    <label for="groomMother">í˜¼ì£¼ ì–´ë¨¸ë‹ˆ ì„±í•¨ *</label>
    <input id="groomMother" type="text" />
    <label for="groomOrder" id="groomOrderLabel">ì‹ ë‘ í˜•ì œê´€ê³„ *</label>
    <select id="groomOrder" class="native-select--hidden" data-ui="custom-select">
      <option value="">ì„ íƒ</option>
      <option>ì¥ë‚¨</option><option>ì°¨ë‚¨</option><option>ì‚¼ë‚¨</option>
      <option>ì‚¬ë‚¨</option><option>ì˜¤ë‚¨</option>
    </select>
    <div class="cselect" data-for="groomOrder" aria-haspopup="listbox">
      <button type="button" class="cselect__btn" id="groomOrderBtn" aria-expanded="false">ì„ íƒ<span class="cselect__arrow"></span></button>
      <div class="cselect__list" role="listbox" aria-labelledby="groomOrderLabel groomOrderBtn"></div>
    </div>
    <label for="groomName">ì‹ ë‘ ì„±ëª… *</label>
    <input id="groomName" type="text" />
  </div>

  <!-- ì‹ ë¶€ì¸¡ -->
  <div class="section">
    <h3>ì‹ ë¶€ì¸¡</h3>
    <label for="brideFather">í˜¼ì£¼ ì•„ë²„ì§€ ì„±í•¨ *</label>
    <input id="brideFather" type="text" />
    <label for="brideMother">í˜¼ì£¼ ì–´ë¨¸ë‹ˆ ì„±í•¨ *</label>
    <input id="brideMother" type="text" />
    <label for="brideOrder" id="brideOrderLabel">ì‹ ë¶€ í˜•ì œê´€ê³„ *</label>
    <select id="brideOrder" class="native-select--hidden" data-ui="custom-select">
      <option value="">ì„ íƒ</option>
      <option>ì¥ë…€</option><option>ì°¨ë…€</option><option>ì‚¼ë…€</option>
      <option>ì‚¬ë…€</option><option>ì˜¤ë…€</option>
    </select>
    <div class="cselect" data-for="brideOrder" aria-haspopup="listbox">
      <button type="button" class="cselect__btn" id="brideOrderBtn" aria-expanded="false">ì„ íƒ<span class="cselect__arrow"></span></button>
      <div class="cselect__list" role="listbox" aria-labelledby="brideOrderLabel brideOrderBtn"></div>
    </div>
    <label for="brideName">ì‹ ë¶€ ì„±ëª… *</label>
    <input id="brideName" type="text" />
  </div>

  <!-- ì˜ˆì‹ ì •ë³´ -->
  <div class="section">
    <h3>ì˜ˆì‹ ì •ë³´</h3>

    <!-- ì €ì¥ìš© hidden -->
    <input type="hidden" id="eventDate" />
    <input type="hidden" id="eventTime" />

    <label>ì˜ˆì‹ì¼ì‹œ *</label>
    <div class="row">
      <div class="field" style="flex:1;">
        <input id="eventDateDisplay" class="display-input" type="text" placeholder="YYYY.MM.DD" readonly />
        <span class="input-icon" aria-hidden="true"
          style="background-image:url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23111%22 stroke-width=%221.6%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><rect x=%223%22 y=%224%22 width=%2218%22 height=%2217%22 rx=%222%22/><path d=%22M8 2v4M16 2v4M3 9h18%22/></svg>');"></span>
      </div>

      <div class="field" style="flex:1;">
        <input id="eventTimeDisplay" class="display-input" type="text" placeholder="ì˜¤ì „ 12:30" readonly />
        <span class="input-icon" aria-hidden="true"
          style="background-image:url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23111%22 stroke-width=%221.6%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><circle cx=%2212%22 cy=%2212%22 r=%229%22/><path d=%22M12 7v6l4 2%22/></svg>');"></span>
      </div>
    </div>
    <small class="hint">â€» í•´ì™¸ì˜ ê²½ìš° í˜„ì§€ì‹œê°„ìœ¼ë¡œ ì…ë ¥ ë°”ëë‹ˆë‹¤.</small>

    <label for="venueAddr">ì˜ˆì‹ì¥ ì£¼ì†Œ *</label>
    <input id="venueAddr" type="text" placeholder="ë„ë¡œëª… ì£¼ì†Œ ê²€ìƒ‰" readonly />

    <label for="venueDetail">ì˜ˆì‹ì¥ ì„¸ë¶€ *</label>
    <input id="venueDetail" type="text" placeholder="ì˜ˆì‹ì¥ ì´ë¦„/í™€ëª…" />

    <label for="isSmallWeddingInput">ìŠ¤ëª°ì›¨ë”© ì—¬ë¶€ *</label>
    <div class="seg" data-for="isSmallWeddingInput">
      <button type="button" class="seg__btn" data-value="ì˜ˆ" aria-pressed="false">ì˜ˆ</button>
      <button type="button" class="seg__btn" data-value="ì•„ë‹ˆì˜¤" aria-pressed="false">ì•„ë‹ˆì˜¤</button>
    </div>
    <input type="hidden" id="isSmallWeddingInput" value="" />

    <label for="flowerInput">í™”í™˜ ìˆ˜ë ¹ *</label>
    <div class="seg" data-for="flowerInput">
      <button type="button" class="seg__btn" data-value="í¬ë§" aria-pressed="false">í¬ë§</button>
      <button type="button" class="seg__btn" data-value="ë¹„í¬ë§" aria-pressed="false">ë¹„í¬ë§</button>
    </div>
    <input type="hidden" id="flowerInput" value="" />
  </div>

  <button class="btn primary" id="btnNext">ì¶”ê°€ ì •ë³´ ì…ë ¥</button>
</div>

<!-- ================== ì˜¤ë²„ë ˆì´(ë‹¬ë ¥/ì‹œê°„ ëª¨ë‹¬) ================== -->
<div id="pickerBackdrop" class="picker-backdrop"></div>

<!-- ë‚ ì§œ í”¼ì»¤ -->
<div id="datePicker" class="picker" role="dialog" aria-modal="true" aria-label="ë‚ ì§œ ì„ íƒ">
  <div class="picker__hdr">
    <div class="cal-topline">
      <div class="cal-left">ì˜ˆì‹ì¼</div>
      <div class="cal-ym" id="dateYM">0000.00</div>
      <div>
        <button class="icon-btn" id="prevMonth" aria-label="ì´ì „ ë‹¬">â€¹</button>
        <button class="icon-btn" id="nextMonth" aria-label="ë‹¤ìŒ ë‹¬">â€º</button>
      </div>
    </div>
  </div>
  <div class="picker__body">
    <div class="cal-head">
      <div class="sun">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="sat">í† </div>
    </div>
    <div id="calGrid" class="cal-grid"></div>
  </div>
  <div class="picker__ftr">
    <button class="picker__btn" id="dateCancel">ì·¨ì†Œ</button>
    <button class="picker__btn primary" id="dateConfirm">í™•ì¸</button>
  </div>
  <input type="hidden" id="tempDate" />
  <input type="hidden" id="calYear" /><input type="hidden" id="calMonth" />
  <div style="position:absolute; left:-9999px;" aria-live="polite" id="dateLive"></div>
  <div style="padding:0 14px 12px; color:#111; font-weight:700;" id="dateSelectedText"></div>
</div>

<!-- ì‹œê°„ í”¼ì»¤ -->
<div id="timePicker" class="picker" role="dialog" aria-modal="true" aria-label="ì‹œê°„ ì„ íƒ">
  <div class="picker__hdr"><div class="picker__title">ì‹œê°„ ì„ íƒ</div></div>
  <div class="picker__body">
    <span id="ampmGroupLabel" class="sr-only">ì˜¤ì „/ì˜¤í›„ ì„ íƒ</span>
    <span id="hourGroupLabel" class="sr-only">ì‹œê°„(ì‹œ) ì„ íƒ</span>
    <span id="minGroupLabel" class="sr-only">ì‹œê°„(ë¶„) ì„ íƒ</span>
    <div class="time-wrap">
      <div class="time-col time-col--ampm" id="ampmCol" role="group" aria-labelledby="ampmGroupLabel"></div>
      <div class="time-col" id="hourCol" role="group" aria-labelledby="hourGroupLabel"></div>
      <div class="time-col" id="minCol" role="group" aria-labelledby="minGroupLabel"></div>
    </div>
  </div>
  <div class="picker__ftr">
    <button class="picker__btn" id="timeCancel">ì·¨ì†Œ</button>
    <button class="picker__btn primary" id="timeConfirm">í™•ì¸</button>
  </div>
  <input type="hidden" id="tempHour" /><input type="hidden" id="tempMin" />
</div>

<script>
/* ================== ì„¤ì •/ìƒìˆ˜ ================== */
// ğŸ‘‰ Apps Script ì›¹ì•± URLë¡œ êµì²´í•˜ì„¸ìš”
const ENDPOINT = "https://script.google.com/macros/s/AKfycb_YOUR_SCRIPT_ID/exec";

/* í•„ìˆ˜ ì…ë ¥ í•­ëª© ëª©ë¡ */
const requiredFields = [
  {id:"groomFather", label:"ì‹ ë‘ ì•„ë²„ì§€ ì„±í•¨"},
  {id:"groomMother", label:"ì‹ ë‘ ì–´ë¨¸ë‹ˆ ì„±í•¨"},
  {id:"groomOrder", label:"ì‹ ë‘ í˜•ì œê´€ê³„"},
  {id:"groomName", label:"ì‹ ë‘ ì„±ëª…"},
  {id:"brideFather", label:"ì‹ ë¶€ ì•„ë²„ì§€ ì„±í•¨"},
  {id:"brideMother", label:"ì‹ ë¶€ ì–´ë¨¸ë‹ˆ ì„±í•¨"},
  {id:"brideOrder", label:"ì‹ ë¶€ í˜•ì œê´€ê³„"},
  {id:"brideName", label:"ì‹ ë¶€ ì„±ëª…"},
  {id:"eventDate", label:"ì˜ˆì‹ ë‚ ì§œ"},
  {id:"eventTime", label:"ì˜ˆì‹ ì‹œê°„"},
  {id:"venueAddr", label:"ì˜ˆì‹ì¥ ì£¼ì†Œ"},
  {id:"venueDetail", label:"ì˜ˆì‹ì¥ ì„¸ë¶€"}
];

/* ================== AI ë¶„ì„ ë²„íŠ¼ ================== */
document.getElementById('btnCheck').addEventListener('click', async ()=>{
  const msg=document.getElementById('msg');
  const url=document.getElementById('inviteUrl').value.trim();
  if(!url){ msg.textContent="âŒ ì²­ì²©ì¥ URLì„ ì…ë ¥í•˜ì„¸ìš”."; msg.style.color="red"; return; }
  msg.textContent="â³ AIë¡œ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..."; msg.style.color="#333";

  try{
    const controller = new AbortController();
    const timeout = setTimeout(()=>controller.abort(), 25000);
    const reqUrl = `${ENDPOINT}?action=extract&url=${encodeURIComponent(url)}`;
    console.log("REQ:", reqUrl);

    const res=await fetch(reqUrl, { signal:controller.signal });
    clearTimeout(timeout);

    if(!res.ok) throw new Error(`ìš”ì²­ ì‹¤íŒ¨ (HTTP ${res.status})`);

    const data=await res.json().catch(()=>{ throw new Error("JSON íŒŒì‹± ì˜¤ë¥˜"); });

    const payload = (data && typeof data==='object' && 'data' in data) ? (data.data || {}) : (data || {});
    if(data.ok){
      groomFather.value=payload.groomFather||"";
      groomMother.value=payload.groomMother||"";
      groomOrder.value=payload.groomOrder||"";
      groomName.value=payload.groomName||"";
      brideFather.value=payload.brideFather||"";
      brideMother.value=payload.brideMother||"";
      brideOrder.value=payload.brideOrder||"";
      brideName.value=payload.brideName||"";

      const dateRaw = payload.eventDate || payload.date || "";
      const timeRaw = payload.eventTime || payload.time || "";
      const dtFromTime = extractDateAndTimeKR(timeRaw);
      const dtFromDate = extractDateAndTimeKR(dateRaw);
      const finalDate = dtFromTime.date || dtFromDate.date || dateRaw || "";
      const finalTime = normalizeToHHMM(timeRaw) || dtFromTime.time || normalizeToHHMM(dtFromDate.time||"") || "";
      setDateDisplay(finalDate);
      setTimeDisplay(finalTime);

      venueAddr.value=payload.venueAddr||"";
      venueDetail.value=payload.venue||"";
      msg.textContent="âœ… AIë¡œ ì˜ˆì‹ ì •ë³´ê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤. í™•ì¸ ë°”ëë‹ˆë‹¤."; msg.style.color="green";
    }else{
      msg.textContent="âŒ ë¶„ì„ ì‹¤íŒ¨: "+(data.error||"Unknown"); msg.style.color="red";
    }
  }catch(err){
    msg.textContent=`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” API ì‘ë‹µ ì‹¤íŒ¨: ${err.message}`; msg.style.color="red";
    console.error(err);
  }
});

/* ================== ëª¨ë‹¬ ì—´ê³ /ë‹«ê¸° ================== */
const backdrop = document.getElementById('pickerBackdrop');
const datePicker = document.getElementById('datePicker');
const timePicker = document.getElementById('timePicker');
const dateDisplay = document.getElementById('eventDateDisplay');
const timeDisplay = document.getElementById('eventTimeDisplay');
const dateHidden = document.getElementById('eventDate');
const timeHidden = document.getElementById('eventTime');
function openPicker(el){ backdrop.style.display='block'; el.style.display='block'; }
function closePicker(){ backdrop.style.display='none'; datePicker.style.display='none'; timePicker.style.display='none'; }
backdrop.addEventListener('click', closePicker);
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePicker(); });

/* ================== ë‹¬ë ¥ ë Œë” ================== */
const calGrid = document.getElementById('calGrid');
const calYear = document.getElementById('calYear');
const calMonth = document.getElementById('calMonth');
const tempDate = document.getElementById('tempDate');
const dateYM = document.getElementById('dateYM');
const dateSelectedText = document.getElementById('dateSelectedText');

const pad = n => String(n).padStart(2,'0');
const toIso = (y,m,d) => `${y}-${pad(m)}-${pad(d)}`;
const pretty = iso => (iso ? iso.split('-').join('.') : '');

function weekdayK(y,m,d){
  const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  return days[new Date(y, m-1, d).getDay()];
}
function setWeekendClass(el, dow){
  if(dow === 0) el.classList.add('sun');
  if(dow === 6) el.classList.add('sat');
}
function renderCal(y, m, selectedIso){
  calYear.value=y; calMonth.value=m;
  dateYM.textContent = `${y}.${pad(m)}`;
  calGrid.innerHTML='';

  const first = new Date(y, m-1, 1);
  const startDow = first.getDay();
  const daysInMonth = new Date(y, m, 0).getDate();

  const today = new Date();
  const todayIso = toIso(today.getFullYear(), today.getMonth()+1, today.getDate());

  for(let i=0;i<startDow;i++){
    const d = new Date(y, m-1, 1 - (startDow - i));
    const div = document.createElement('div');
    div.className='cal-day out';
    div.textContent = String(d.getDate());
    setWeekendClass(div, d.getDay());
    calGrid.appendChild(div);
  }

  for(let d=1; d<=daysInMonth; d++){
    const iso = toIso(y, m, d);
    const dow = new Date(y, m-1, d).getDay();
    const btn = document.createElement('button');
    btn.type='button'; btn.className='cal-day'; btn.textContent=String(d);

    setWeekendClass(btn, dow);
    if(iso===todayIso) btn.classList.add('today');
    if(selectedIso && iso===selectedIso) btn.classList.add('sel');

    btn.addEventListener('click', ()=>{
      tempDate.value = iso;
      [...calGrid.querySelectorAll('.cal-day')].forEach(b=>b.classList.remove('sel'));
      btn.classList.add('sel');
      dateSelectedText.textContent = `ì„ íƒëœ ë‚ ì§œ: ${pretty(iso)}(${weekdayK(y,m,d)})`;
    });

    calGrid.appendChild(btn);
  }
}
document.getElementById('prevMonth').addEventListener('click', ()=>{
  let y=Number(calYear.value), m=Number(calMonth.value)-1; if(m<1){m=12;y--;}
  renderCal(y,m,tempDate.value||dateHidden.value||'');
});
document.getElementById('nextMonth').addEventListener('click', ()=>{
  let y=Number(calYear.value), m=Number(calMonth.value)+1; if(m>12){m=1;y++;}
  renderCal(y,m,tempDate.value||dateHidden.value||'');
});
document.getElementById('dateCancel').addEventListener('click', closePicker);
document.getElementById('dateConfirm').addEventListener('click', ()=>{
  const iso = tempDate.value;
  if(iso){
    const [yy,mm,dd] = iso.split('-').map(n=>+n);
    dateHidden.value = iso;
    dateDisplay.value = pretty(iso);
    dateDisplay.removeAttribute('aria-invalid');
    dateSelectedText.textContent = `ì„ íƒëœ ë‚ ì§œ: ${pretty(iso)}(${weekdayK(yy,mm,dd)})`;
  }else{
    dateDisplay.setAttribute('aria-invalid','true');
  }
  closePicker();
});
function setDateDisplay(iso){
  dateHidden.value = iso || '';
  if(iso){
    const [yy,mm,dd] = iso.split('-').map(n=>+n);
    dateDisplay.value = pretty(iso);
    dateSelectedText.textContent = `ì„ íƒëœ ë‚ ì§œ: ${pretty(iso)}(${weekdayK(yy,mm,dd)})`;
  }else{
    dateDisplay.value = '';
    dateSelectedText.textContent = '';
  }
}
dateDisplay.addEventListener('click', ()=>{
  openPicker(datePicker);
  const base = dateHidden.value ? new Date(dateHidden.value) : new Date();
  tempDate.value = dateHidden.value || '';
  if(tempDate.value){
    const [yy,mm,dd] = tempDate.value.split('-').map(n=>+n);
    dateSelectedText.textContent = `ì„ íƒëœ ë‚ ì§œ: ${pretty(tempDate.value)}(${weekdayK(yy,mm,dd)})`;
  }else{
    dateSelectedText.textContent = '';
  }
  renderCal(base.getFullYear(), base.getMonth()+1, tempDate.value);
});

/* ================== ì‹œê°„ í”¼ì»¤(ì„¸ë¡œ 3ì—´) ================== */
const ampmCol = document.getElementById('ampmCol');
const hourCol = document.getElementById('hourCol');
const minCol  = document.getElementById('minCol');
const tempHour = document.getElementById('tempHour');
const tempMin  = document.getElementById('tempMin');
let tempAmpm = 'ì˜¤ì „';

function to12h(h24){
  const n = parseInt(h24,10);
  if(isNaN(n)) return {ampm:'ì˜¤ì „', h:'12'};
  if(n===0) return {ampm:'ì˜¤ì „', h:'12'};
  if(n===12) return {ampm:'ì˜¤í›„', h:'12'};
  if(n>12) return {ampm:'ì˜¤í›„', h:String(n-12).padStart(2,'0')};
  return {ampm:'ì˜¤ì „', h:String(n).padStart(2,'0')};
}
function to24h(ampm, h12){
  let n = parseInt(h12,10) || 0;
  if(ampm==='ì˜¤ì „'){ if(n===12) n=0; }
  else{ if(n<12) n+=12; }
  return String(n).padStart(2,'0');
}
function renderTimeCols(selAmpm='ì˜¤ì „', selH='12', selM='00'){
  ampmCol.innerHTML='';
  ['ì˜¤ì „','ì˜¤í›„'].forEach(v=>{
    const b=document.createElement('button'); b.type='button'; b.className='time-item'; b.textContent=v; b.dataset.v=v;
    if(v===selAmpm) b.classList.add('sel');
    b.addEventListener('click', ()=>{
      tempAmpm=v; ampmCol.querySelectorAll('.time-item').forEach(x=>x.classList.remove('sel')); b.classList.add('sel');
    });
    ampmCol.appendChild(b);
  });

  hourCol.innerHTML='';
  for(let h=1; h<=12; h++){
    const v=String(h).padStart(2,'0');
    const b=document.createElement('button'); b.type='button'; b.className='time-item'; b.textContent=v; b.dataset.v=v;
    if(v===selH) b.classList.add('sel');
    b.addEventListener('click', ()=>{
      tempHour.value=v; hourCol.querySelectorAll('.time-item').forEach(x=>x.classList.remove('sel')); b.classList.add('sel');
      b.scrollIntoView({block:'center', behavior:'smooth'});
    });
    hourCol.appendChild(b);
    if(v===selH) queueMicrotask(()=>b.scrollIntoView({block:'center'}));
  }

  minCol.innerHTML='';
  ['00','10','20','30','40','50'].forEach(v=>{
    const b=document.createElement('button'); b.type='button'; b.className='time-item'; b.textContent=v; b.dataset.v=v;
    if(v===selM) b.classList.add('sel');
    b.addEventListener('click', ()=>{
      tempMin.value=v; minCol.querySelectorAll('.time-item').forEach(x=>x.classList.remove('sel')); b.classList.add('sel');
      b.scrollIntoView({block:'center', behavior:'smooth'});
    });
    minCol.appendChild(b);
    if(v===selM) queueMicrotask(()=>b.scrollIntoView({block:'center'}));
  });
}
timeDisplay.addEventListener('click', ()=>{
  openPicker(timePicker);
  const v = timeHidden.value;
  let h='12', m='00'; tempAmpm='ì˜¤ì „';
  if(/^\d{2}:\d{2}$/.test(v)){
    const [hh,mm] = v.split(':'); const t=to12h(hh);
    tempAmpm=t.ampm; h=t.h; m=mm;
  }
  tempHour.value=h; tempMin.value=m;
  renderTimeCols(tempAmpm, h, m);
});
document.getElementById('timeCancel').addEventListener('click', closePicker);
document.getElementById('timeConfirm').addEventListener('click', ()=>{
  const h12=tempHour.value, m=tempMin.value;
  if(h12 && m){
    const hh = to24h(tempAmpm, h12);
    const val = `${hh}:${m}`;
    timeHidden.value = val;
    timeDisplay.value = `${tempAmpm} ${h12}:${m}`;
    timeDisplay.removeAttribute('aria-invalid');
  }else{
    timeDisplay.setAttribute('aria-invalid','true');
  }
  closePicker();
});

/* ================== ì‹œê°„ ì •ê·œí™”/ìì—°ì–´ íŒŒì„œ ================== */
function normalizeToHHMM(raw){
  if(!raw) return '';
  let s = String(raw).trim()
    .replace(/\s+/g,' ')
    .replace(/ì‹œ/g,':')
    .replace(/ë¶„/g,'')
    .replace(/\.00\b/g,':00');

  // 1300 -> 13:00
  if(/^\d{3,4}$/.test(s) && !s.includes(':')){
    const mm = s.slice(-2), hh = s.slice(0, s.length-2);
    s = `${hh}:${mm}`;
  }

  const hms = s.match(/^(\d{1,2}):(\d{2})(?::\d{2})?$/);
  const ap  = s.match(/^(ì˜¤ì „|ì˜¤í›„|AM|PM|am|pm)\s*(\d{1,2})(?::|ì‹œ)?\s*(\d{2})?$/);

  if(ap){
    const ampm = ap[1].toLowerCase();
    let h12 = parseInt(ap[2],10);
    const mm = ap[3] || '00';
    if(ampm==='ì˜¤ì „' || ampm==='am'){ if(h12===12) h12=0; }
    else { if(h12<12) h12+=12; }
    return `${String(h12).padStart(2,'0')}:${mm}`;
  }

  if(hms){
    let hh = parseInt(hms[1],10);
    const mm = hms[2];
    if(hh>24) hh = hh % 24;
    return `${String(hh).padStart(2,'0')}:${mm}`;
  }
  return '';
}

function extractDateAndTimeKR(raw){
  const out = { date:'', time:'' };
  if(!raw) return out;
  const s = String(raw).trim();
  const re = /(?:(\d{4})\s*ë…„\s*(\d{1,2})\s*ì›”\s*(\d{1,2})\s*ì¼)?(?:\s*[ì¼ì›”í™”ìˆ˜ëª©ê¸ˆí† ]ìš”ì¼)?(?:\s*(ì˜¤ì „|ì˜¤í›„|AM|PM|am|pm)?\s*(\d{1,2})(?:\s*ì‹œ)?(?:\s*(\d{1,2})\s*ë¶„?)?)?/;
  const m = s.match(re);
  if(m){
    const [, yy, mm, dd, ap, hStr, minStr] = m;
    if(yy && mm && dd){
      out.date = `${yy}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
    }
    if(hStr){
      const mm2 = minStr?String(minStr).padStart(2,'0'):'00';
      if(ap){
        let h = parseInt(hStr,10)||0;
        const apLow = ap.toLowerCase();
        if(apLow==='ì˜¤ì „'||apLow==='am'){ if(h===12) h=0; } else { if(h<12) h+=12; }
        out.time = `${String(h).padStart(2,'0')}:${mm2}`;
      }else{
        out.time = normalizeToHHMM(`${hStr}:${mm2}`);
      }
    }
  }
  if(!out.time){
    const t = normalizeToHHMM(s);
    if(t) out.time = t;
  }
  return out;
}

/** ì™¸ë¶€ì—ì„œ ì‹œê°„ ê°’ ì„¸íŒ…(24ì‹œê°„ "HH:MM") */
function setTimeDisplay(v){
  const norm = normalizeToHHMM(v);
  if(norm){
    timeHidden.value = norm;
    const [hh,mm] = norm.split(':'); const t=to12h(hh);
    timeDisplay.value = `${t.ampm} ${t.h}:${mm}`;
    timeDisplay.removeAttribute('aria-invalid');
  }else{
    timeHidden.value = ''; timeDisplay.value = '';
  }
}

/* ================== ì»¤ìŠ¤í…€ ì…€ë ‰íŠ¸ ì¦ê°• ================== */
function enhanceSelect(selectEl){
  const wrap = document.querySelector(`.cselect[data-for="${selectEl.id}"]`);
  if(!wrap) return;
  const btn = wrap.querySelector('.cselect__btn');
  const list = wrap.querySelector('.cselect__list');
  if(!btn.firstChild) btn.appendChild(document.createTextNode('ì„ íƒ'));

  function render(){
    list.innerHTML = '';
    [...selectEl.options].forEach(opt=>{
      const div=document.createElement('div');
      div.className='cselect__option'; div.setAttribute('role','option');
      div.dataset.value = opt.value; div.textContent = opt.textContent;
      div.setAttribute('aria-selected', String(opt.selected));
      div.addEventListener('click', ()=>{
        selectEl.value = opt.value;
        btn.firstChild.nodeValue = opt.textContent || 'ì„ íƒ';
        [...list.children].forEach(n=>n.setAttribute('aria-selected','false'));
        div.setAttribute('aria-selected','true');
        list.classList.remove('is-open'); btn.setAttribute('aria-expanded','false');
        selectEl.dispatchEvent(new Event('change'));
      });
      list.appendChild(div);
    });
    const selOpt = selectEl.selectedOptions[0];
    btn.firstChild.nodeValue = selOpt ? selOpt.textContent : 'ì„ íƒ';
  }

  render();
  btn.addEventListener('click', ()=>{
    const open = list.classList.toggle('is-open');
    btn.setAttribute('aria-expanded', String(open));
  });
  document.addEventListener('click', (e)=>{
    if(!wrap.contains(e.target)){
      list.classList.remove('is-open'); btn.setAttribute('aria-expanded','false');
    }
  });
  btn.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){ list.classList.remove('is-open'); btn.setAttribute('aria-expanded','false'); }
  });
  selectEl.addEventListener('change', render);
}
document.querySelectorAll('select[data-ui="custom-select"]').forEach(enhanceSelect);

/* ================== ì„¸ê·¸ë¨¼íŠ¸ í† ê¸€ ================== */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.seg__btn'); if(!btn) return;
  const seg = btn.closest('.seg'); const hiddenId = seg?.getAttribute('data-for');
  const hidden = hiddenId ? document.getElementById(hiddenId) : null;
  if(!seg || !hidden) return;
  seg.querySelectorAll('.seg__btn').forEach(b=>{ b.setAttribute('aria-pressed','false'); b.classList.remove('is-selected'); });
  btn.setAttribute('aria-pressed','true'); btn.classList.add('is-selected');
  hidden.value = btn.dataset.value || '';
});

/* ================== ìˆ˜ê¸° ì…ë ¥ ëª¨ë“œ ì „í™˜ ================== */
const noInviteEl = document.getElementById('noInvite');
const inviteUrlBlock = document.getElementById('inviteUrlBlock');
const btnCheck = document.getElementById('btnCheck');
function updateInviteMode(){
  const off = noInviteEl.checked;
  inviteUrlBlock.classList.toggle('hidden', off);
  btnCheck.classList.toggle('hidden', off);
  if(off){ document.getElementById('inviteUrl').value=''; }
}
noInviteEl.addEventListener('change', updateInviteMode);
updateInviteMode();

/* ================== ë‹¤ìŒ ë‹¨ê³„ ë²„íŠ¼ ================== */
document.getElementById('btnNext').addEventListener('click', ()=>{
  for(const field of requiredFields){
    const el=document.getElementById(field.id);
    if(!el || !String(el.value).trim()){
      alert("âŒ í•„ìˆ˜ ì…ë ¥ê°’ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: " + field.label);
      return;
    }
  }
  const info={
    inviteUrl:document.getElementById('inviteUrl').value,
    noInvite:document.getElementById('noInvite').checked,
    groomFather:document.getElementById('groomFather').value,
    groomMother:document.getElementById('groomMother').value,
    groomOrder:document.getElementById('groomOrder').value,
    groomName:document.getElementById('groomName').value,
    brideFather:document.getElementById('brideFather').value,
    brideMother:document.getElementById('brideMother').value,
    brideOrder:document.getElementById('brideOrder').value,
    brideName:document.getElementById('brideName').value,
    eventDate:document.getElementById('eventDate').value,  // YYYY-MM-DD
    eventTime:document.getElementById('eventTime').value,  // HH:MM (24h)
    venueAddr:document.getElementById('venueAddr').value,
    venueDetail:document.getElementById('venueDetail').value,
    isSmallWedding:document.getElementById('isSmallWeddingInput').value,
    flower:document.getElementById('flowerInput').value
  };
  localStorage.setItem('inviteInfo', JSON.stringify(info));
  location.href='wedding_detail.html';
});
</script>

<!-- Daum Postcode API -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
  document.getElementById('venueAddr').addEventListener('click', function(){
    new daum.Postcode({
      oncomplete: function(data) {
        document.getElementById('venueAddr').value = data.address;
      }
    }).open();
  });
</script>
</body>
</html>
